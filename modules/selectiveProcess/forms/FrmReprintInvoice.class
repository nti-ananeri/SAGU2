<?php

/**
 * Inscription form
 *
 * @author Hélio Henrique Rodrigues Guimarães [helio@solis.coop.br]
 *
 * @version: $Id$
 * 
 * \b Maintainers \n
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Daniel Afonso Heisler [daniel@solis.coop.br]
 * Jamiel Spezia [jamiel@solis.coop.br]
 * Rafael Luís Spengler [rafael@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 *
 * @since
 * Class created on 05/07/2006
 *
 * \b Organization: \n
 * SOLIS - Cooperativa de Soluções Livres \n
 * The SAGU2 Development Team
 *
 * \b CopyLeft: \n
 * CopyLeft (L) 2005 SOLIS - Cooperativa de Soluções Livres \n
 *
 * \b License: \n
 * Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html)
 *
 * \b History: \n
 * See history in CVS repository: http://sagu.solis.coop.br/
 *
 **/

/**
 * Form to manipulate a selectiveProcessOccurrence
 **/
class FrmReprintInvoice extends MForm
{
    private $_invoiceId;
    private $rg_number;
    private $cpf_number;
	private $selectiveProcessId;
    /**
     * Class constructor
     **/
    function __construct()
    {
        $module = MIOLO::getCurrentModule();
        $MIOLO    = MIOLO::getInstance();

        parent::__construct(_M('Selective process reprint invoice', $module));

        $this->setHelp(get_class($this), MIOLO::getCurrentModule(), MIOLO::getCurrentAction());
        $this->eventHandler();
    }

    /**
     * Default method to define fields
     **/
    public function createFields()
    {
        $MIOLO    = MIOLO::getInstance();
        $module   = MIOLO::getCurrentModule();
        $action   = MIOLO::getCurrentAction();
        $function = MIOLO::_request('function');
		$this->selectiveProcessId = $this->selectiveProcessId ? $this->selectiveProcessId : (MIOLO::_request('selectiveProcessId','GET') ? MIOLO::_request('selectiveProcessId','GET'):'');
        $divError = new MDiv('divError', null, null, 'align=center');
        $fields[] = $divError;
		
        $businessInscriptionSetting = $MIOLO->getBusiness($module, 'BusInscriptionSetting');
        $inscriptionSetting         = $businessInscriptionSetting->getInscriptionSetting($this->selectiveProcessId);

        $msgInscriptionText =  "<b><font size=3><center>". _M('REPRINT INVOICE TO SELECTIVE PROCESS', $module)." " . $this->selectiveProcessId . "<br><br></b>";
        $msgInscriptionText .= "<font size=2>"._M('Inform the invoice code from your inscription, rg code or cfp code and click on the button', $module)."<br><br> ";

        $invoiceIdLabel = new MText('invoiceIdLabel', _M('Invoice id',$module) . ':');
        $invoiceIdLabel->setWidth(FIELD_CONTAINER_SIZE);

        $invoiceId = new MTextField('invoiceId', $this->getFormValue('invoiceId', $data->invoiceId), '', FIELD_ID_SIZE);
        $invoiceId->setReadOnly(false);
        $invoiceId->setJsHint(_M('Invoice id',$module));

        $cntInvoice     = new MHContainer('cntInvoice', array($invoiceIdLabel, $invoiceId));

        $rgLabel = new MText('rgLabel', _M('Identity (RG)',$module).':');
        $rgLabel->setWidth(FIELD_CONTAINER_SIZE);

        $rgId   = new MTextField('rgId', $this->getFormValue('rgId', $this->inscriptionData->document->rgNumber), '', 20);
        $rgId->setJsHint(_M('Inform the identity number (rg)',$module));

        $hctRg = new MHContainer('hctRg', array($rgLabel, $rgId));
        $hctRg->setShowLabel(true);

        $cpfLabel = new MText('cpfLabel', _M('CPF',$module).':');
        $cpfLabel->setWidth(FIELD_CONTAINER_SIZE);

        $cpfId   = new MTextField('cpfId', $this->getFormValue('cpfId', $this->inscriptionData->document->cpf), '', 20/*, 'Inform the identity number (rg)'*/);
        $cpfId->setJsHint(_M('Inform the cpf number',$module));

        $validators[]  = new MCPFValidator('cpfId', _M('CPF',$module), 'optional');

        $hctCpf = new MHContainer('hctCpf', array($cpfLabel, $cpfId));
        $hctCpf->setShowLabel(true);


        $limbo = new Separator('');

        $div1       = new MDiv('div1', array($cntInvoice, $limbo, $hctRg, $limbo, $hctCpf), null, 'align=left');

        $this->_invoiceId = $invoiceId->value;
        $this->rg_number  = $rgId->value;
        $this->cpf_number = $cpfId->value;

        $btnReprintInvoice = new MButton('btnReprintInvoice',_M('Reprint invoice',$module));
        $btnReprintInvoice->attachEventHandler('click', 'tbBtnReprintInvoice_click', true);

        $div2       = new MDiv('div2', $btnReprintInvoice, null, 'align=center');

        $separator = new Separator('');

        $msgInscription     = new MText('msgInscription', $msgInscriptionText);
        $cntInscription     = new MHContainer('cntInscription', array($msgInscription, $div1, $separator, $div2));

        $cntInscription->addBoxStyle('background', 'white');
        $cntInscription->setDisposition('center');

        $fields[] = $cntInscription;

        $fields[] = new Separator('');

        $this->setFields($fields);
        $this->setValidators($validators);

        $this->setLabelWidth(FIELD_LABEL_SIZE);
        $this->setShowPostButton(false);
        $this->setClose($MIOLO->getActionURL($module,substr($action,0,strrpos($action,':'))));
    }

    /**
     * Event triggered when user click re print invoice
     **/
    public function tbBtnReprintInvoice_click($sender = null)
    {
        $MIOLO                         = MIOLO::getInstance();
        $module                        = MIOLO::getCurrentModule();
        $action                        = MIOLO::getCurrentAction();

        $businessInscription           = $MIOLO->getBusiness($module, 'BusInscription');

        if ( strlen((string)$this->_invoiceId) > 0 )
        {
            $invoiceId         = $this->_invoiceId;
        }
        elseif ( (strlen((string)$this->rg_number) > 0) || (strlen((string)$this->cpf_number) > 0) )
        {
            $filters->rgNumber  = $this->rg_number;
            $filters->cpfNumber = SAGU::convertInCPFWithoutDelimiters($this->cpf_number);

            $invoiceId = $businessInscription->getInvoiceId($filters);
        }
        else
        {
            //Erro, nenhum dos campos informados
            $lblMsg1 = new MText('lblMsg1', _M('Please, inform one field',$module));
            $lblMsg1->color = 'red';

            $cntErrors      = new MVContainer('cntErrors', array($lblMsg1));
            $this->divError->addControl($cntErrors);
        }

        if ( strlen((string)$invoiceId) > 0 )
        {
            $verifyInvoice                 = $businessInscription->verifyInvoiceId($invoiceId);

            if ( is_array( $verifyInvoice ) )
            {
                $opts = array('event'=>'submit_button_click', '_invoiceId' => $invoiceId);
                $this->page->mGoto($MIOLO->getActionURL('finance', "main:process:printInvoice", null, $opts ));
            }
            else
            {
                $lblMsg1 = new MText('lblMsg1', _M('Invalid invoice code:',$module));
                $lblMsg1->color = 'red';

                $cntErrors      = new MVContainer('cntErrors', array($lblMsg1));
                $this->divError->addControl($cntErrors);
            }
        }
        else
        {
            $this->addError(_M('Incorrect datas', $module)) . '.';
        }
    }
}

?>
