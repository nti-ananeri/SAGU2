<?php
set_time_limit(0);        
$MIOLO  = MIOLO::getInstance();
define('REPORT_ID', 'Contrato de Adesão Para Prestação de Serviços Educacionais'); 
$module = 'academic';
define('FPDF_FONTPATH', $MIOLO->getModulePath('basic', '/classes/fpdf/font/'));
$MIOLO->Uses('classes/fpdf/pdf.php', 'basic');

class RptClassTeste2 extends PDF
{
    public function __construct($filters = NULL)
    {
        $MIOLO = MIOLO::getInstance();

        $title = MIOLO::_request('title');
        $this->title = strtoupper($title);
//      $this->title = strtoupper(REPORT_ID);
        $parameter = MIOLO::_request('parameter');
        $a = constant($parameter);
        $db = $MIOLO->getBusiness('academic', 'BusContractDocument');
        $b->contractId = 22827;
//        $b->personId = 464;
        $filters = $db->getContract($b);
        $filters->contractText = $a;
        parent::__construct();
        $this->useUserInfo = false;
        $this->AddPage('P', 'mm', 'A4');
        $this->aliasNbPages();
        $this->generatePDF($filters);
    }
	
    public function generatePDF($data)
    {
        $this->generateContent($data);
        PDF::generatePDF();
    }

    public function Header()
    {
        parent::Header();
    }
    
    public function Footer()
    {
        parent::Footer();
    }

    private function replaceText($rdata)
    {
        $parcelValue = $rdata->courseInfo->value/$rdata->contract->parcelsNumber;
        $courseValue = $rdata->courseInfo->value;
        $enrollValue = $rdata->courseInfo->enrollValue;
        $courseTotalNumberHours = $rdata->contract->courseTotalNumberHours;
        
        $procurar[] = '$CURDAY';
        $substituir[] = date('d');

        $procurar[] = '$CURMONTHEXT';
        $substituir[] =  _M(date('F'), 'academic');

        $procurar[] = '$CURMONTH';
        $substituir[] = date('m');

        $procurar[] = '$CURYEAR';
        $substituir[] =  date('Y');

        $procurar[] = '$PERIOD';
        $substituir[] =  CURRENT_PERIOD_ID;
        
        $procurar[] = '$LEGALPERSON_CNPJ';
        $substituir[] =   $this->pdfInfo->legalPerson->cnpj;

        $procurar[] = '$LEGALPERSON_ADDRESS';
        $substituir[] =   $this->pdfInfo->legalPersonAddress;

        $procurar[] = '$LEGALPERSON_NAME';
        $substituir[] =   $this->pdfInfo->legalPersonName;

        $procurar[] = '$LEGALPERSON_SHORTNAME';
        $substituir[] =   $this->pdfInfo->legalPerson->shortName;

        $procurar[] = '$COMPANY_NAME';
        $substituir[] =   $this->pdfInfo->company->name;

        $procurar[] = '$COMPANY_SHORTNAME';
        $substituir[] =   $this->pdfInfo->company->acronym;

        $procurar[] = '$MATURITYDAY_EXTENSIVE';
        $substituir[] =   strtolower(SAGU::returnExtenseNumber($rdata->contract->maturityDay));

        $procurar[] = '$MATURITYDAY';
        $substituir[] =   $rdata->contract->maturityDay;
        
        if ( $rdata->policy->isDiscountInPercent )
        {
            $procurar[] = '$POLICY_DISCOUNT_VALUE_EXTENSIVE';
            $substituir[] =    strtolower(SAGU::returnExtenseNumber($rdata->policy->discount)) . ' por cento';
            $procurar[] = '$POLICY_DISCOUNT_VALUE';
            $substituir[] =   $rdata->policy->discount . ' %';
        }
        else
        {
            $procurar[] = '$POLICY_DISCOUNT_VALUE_EXTENSIVE';
            $substituir[] =    strtolower(SAGU::returnExtenseNumber($rdata->policy->discount)) . ' REAIS';
            $procurar[] = '$POLICY_DISCOUNT_VALUE';
            $substituir[] =   'R$ ' . $rdata->policy->discount;
        }

        $procurar[] = '$POLICY_DAYS_TO_DISCOUNT_EXTENSIVE';
        $substituir[] =   strtolower(SAGU::extensive($rdata->contract->maturityDay -($rdata->policy->daysToDiscount)));

        $procurar[] = '$POLICY_DAYS_TO_DISCOUNT';
        $substituir[] =   $rdata->contract->maturityDay -($rdata->policy->daysToDiscount);

        $procurar[] = '$PARCELS_NUMBER';
        $substituir[] =   $rdata->contract->parcelsNumber; 

        $procurar[] = '$PARCELS_NUMBER_EXENSIVE';
        $substituir[] =    strtolower(SAGU::returnExtenseNumber($rdata->contract->parcelsNumber, 'F')); 

        $procurar[] = '$PARCEL_VALUE_EXTENSIVE';
        $substituir[] =   SAGU::extensive($parcelValue, 'M', true); 

        $procurar[] = '$PARCEL_VALUE';
        $substituir[] =   SAGU::formatNumber($parcelValue,true); 

        $procurar[] = '$COURSE_VALUE_EXTENSIVE';
        $substituir[] =   SAGU::extensive($courseValue, 'M', true); 

        $procurar[] = '$COURSE_VALUE';
        $substituir[] =   SAGU::formatNumber($courseValue, true); 

        $procurar[] = '$ENROLL_VALUE_EXTENSIVE';
        $substituir[] =   SAGU::extensive($enrollValue, 'M', true); 

        $procurar[] = '$ENROLL_VALUE';
        $substituir[] =   SAGU::formatNumber($enrollValue, true); 
        
        $procurar[] = '$COURSENAME';
        $substituir[] =   $rdata->contract->courseName; 

        $procurar[] = '$COURSE_TURN';
        $substituir[] =   $rdata->contract->turn; 

        $procurar[] = '$COURSEVERSION';
        $substituir[] =   $rdata->contract->courseVersion; 

        $procurar[] = '$COURSE_SEMESTER_TOTAL_EXTENSIVE';
        $substituir[] =   strtolower(SAGU::extensive($rdata->contract->courseSemesterTotal)); 

        $procurar[] = '$COURSE_SEMESTER_TOTAL';
        $substituir[] =   $rdata->contract->courseSemesterTotal; 

        $procurar[] = '$COURSE_TOTAL_NUMBER_HOURS_EXTENSIVE';
        $substituir[] =   strtolower(SAGU::extensive($courseTotalNumberHours, 'F')); 
        
        $procurar[] = '$COURSE_TOTAL_NUMBER_HOURS';
        $substituir[] =   $courseTotalNumberHours; 

        $procurar[] = '$CONTRACT_PERSONNAME';
        $substituir[] =   $rdata->contract->name; 
        
        $procurar[] = '$CONTRACT_RESIDENTIALPHONE';
        $substituir[] =   $rdata->contract->residentialPhone; 

        $procurar[] = '$CONTRACT_WORKPHONE';
        $substituir[] =   $rdata->contract->workPhone; 

        $procurar[] = '$CONTRACT_MOBILE';
        $substituir[] =   $rdata->contract->cellPhone; 

        $procurar[] = '$CONTRACT_MARITALSTATUS';
        $substituir[] =   $rdata->contract->maritalStatus; 

        $procurar[] = '$CONTRACT_RG';
        $substituir[] =   $rdata->contract->rg; 

        $procurar[] = '$CONTRACT_CPF';
        $substituir[] =   $rdata->contract->cpf;

        $procurar[] = '$CONTRACT_LOCATION';
        $substituir[] =   $rdata->contract->location;

        $procurar[] = '$CONTRACT_ID';
        $substituir[] =   $rdata->contract->contractId;

        $procurar[] = '$CONTRACT_ADDRESSNUMBER';
        $substituir[] =   $rdata->contract->number;

        $procurar[] = '$CONTRACT_ZIPCODE';
        $substituir[] =   $rdata->contract->zipCode;

        $procurar[] = '$CONTRACT_CITYNAME';
        $substituir[] =   $rdata->contract->cityName;

        $procurar[] = '$CONTRACT_NEIGHBORHOOD';
        $substituir[] =   $rdata->contract->neighborhood;
        
        $procurar[] = '$RESPONSABLE_PERSONNAME';
        $substituir[] =   $rdata->responsable->name; 
        
        $procurar[] = '$RESPONSABLE_MARITALSTATUS';
        $substituir[] =   $rdata->responsable->maritalStatus; 

        $procurar[] = '$RESPONSABLE_RG';
        $substituir[] =   $rdata->responsable->rg; 

        $procurar[] = '$RESPONSABLE_CPF';
        $substituir[] =   $rdata->responsable->cpf;

        $procurar[] = '$RESPONSABLE_LOCATION';
        $substituir[] =   $rdata->responsable->location;

        $procurar[] = '$RESPONSABLE_ADDRESSNUMBER';
        $substituir[] =   $rdata->responsable->number;

        $procurar[] = '$RESPONSABLE_ZIPCODE';
        $substituir[] =   $rdata->responsable->zipCode;

        $procurar[] = '$RESPONSABLE_CITYNAME';
        $substituir[] =   $rdata->responsable->cityName;

        $procurar[] = '$RESPONSABLE_NEIGHBORHOOD';
        $substituir[] =   $rdata->responsable->neighborhood;

        $procurar[] = '$RESPONSABLE_RESIDENTIALPHONE';
        $substituir[] =   $rdata->responsable->residentialPhone; 

        $procurar[] = '$RESPONSABLE_WORKPHONE';
        $substituir[] =   $rdata->responsable->workPhone; 

        $procurar[] = '$RESPONSABLE_MOBILE';
        $substituir[] =   $rdata->responsable->cellPhone; 
 
        $procurar[] = '$COURSE_ENDDATE';
        $substituir[] =   $rdata->courseInfo->endDate;
        
        $procurar[] = '$COURSE_BEGINDATE';
        $substituir[] =   $rdata->courseInfo->beginDate;
        
        if ( strlen((string)$rdata->contractText) > 0 )
        {
            $text = $rdata->contractText;
        }
        elseif ( $rdata->contract->formationLevelId == GRADUATION_FORMATION_LEVEL_ID )
        {
            if ( $rdata->responsable->cpf != $rdata->contract->cpf && strlen((string)$rdata->responsable->cpf) > 0 && defined('GRADUATION_DOCUMENT_TEXT_RESPONSABLE') )
            {
                $text = GRADUATION_DOCUMENT_TEXT_RESPONSABLE;
            }
            else
            {
                $text = GRADUATION_DOCUMENT_TEXT;
            }
        }
        elseif ( $rdata->contract->formationLevelId == TECHNICAL_FORMATION_LEVEL_ID )
        {
            $text = TECHNICAN_DOCUMENT_TEXT;
        }
        elseif ( $rdata->contract->formationLevelId == MASTER_FORMATION_LEVEL_ID)
        {
            $text = MASTER_DOCUMENT_TEXT;
        }
        elseif ( $rdata->contract->formationLevelId == AFTER_GRADUATION_FORMATION_LEVEL_ID )
        {
            $text = AFTER_GRADUATION_DOCUMENT_TEXT;
        }
        elseif ( $rdata->contract->formationLevelId == EXTENSION_FORMATION_LEVEL_ID)
        {
            $text = EXTENSION_DOCUMENT_TEXT;
        }
        $text = str_replace($procurar, $substituir, $text);

        return $text;
    }

    protected function generateContent($rdata)
    {	   
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $module = 'academic';
    	$transDay[5] = 'cinco';
        $transDay[6] = 'seis';
        $transDay[10] = 'dez';
    	$transMonth[1]  = _M('January', $module); 
    	$transMonth[2]  = _M('February', $module);
    	$transMonth[3]  = _M('March', $module);
    	$transMonth[4]  = _M('April', $module);
    	$transMonth[5]  = _M('May', $module);
        $transMonth[6]  = _M('June', $module);
        $transMonth[7]  = _M('July', $module);
        $transMonth[8]  = _M('August', $module);
        $transMonth[9]  = _M('September', $module);
        $transMonth[10] = _M('October', $module);
        $transMonth[11] = _M('November', $module);
        $transMonth[12] = _M('December', $module);            
    
     	$this->setFont(DEFAULT_REPORT_FONT, '', 8);


        $text = $this->replaceText($rdata);
     
        $this->multiCell($this->psize, $this->lsize,$text, null, 'J');
        $this->ln();
        $this->ln(10);
        $this->MultiCell($this->psize, 5,$rdata->company->cityName.', '.date('d').' de '.$transMonth[date('n')].' de '.date('Y'),'','C');  
        $this->ln(10);
 		$this->Cell(($this->psize/10)*2, 5,'','','C');
    	$this->Cell(($this->psize/10)*6, 5,'','B','C');
        $this->ln(5);
   		$this->MultiCell($this->psize, 5,$this->pdfInfo->legalPerson->name . ' - ' . $this->pdfInfo->legalPerson->shortName ,'','C');
    	$this->ln(10);		
	    $this->Cell(($this->psize/10)*2, 5,'','','C');
        $this->Cell(($this->psize/10)*6, 5,'','B','C');
        $this->ln(5);
      	$this->MultiCell($this->psize, 5,'DISCENTE/CONTRATANTE' ,'','C');
	    $this->ln(10);		

        
        if ( $rdata->contract->cpf != $rdata->responsable->cpf && strlen((string)$rdata->responsable->cpf) > 0  )
        {

    		$this->Cell(($this->psize/10)*2, 5,'','','C');
	    	$this->Cell(($this->psize/10)*6, 5,'','B','C');
            $this->ln(5);
	    	$this->MultiCell($this->psize, 5,'FIADOR' ,'','C');
		    $this->ln(10);		
        }

        $this->Cell(($this->psize/14)*0.5, 5, '');
        $this->Cell(($this->psize/14)*6, 5,'', 'B');
        $this->Cell(($this->psize/14)*0.5, 5, '');
        $this->Cell(($this->psize/14)*0.5, 5, '');
        $this->Cell(($this->psize/14)*6, 5,'', 'B');
        $this->ln();
        $this->Cell(($this->psize/14)*0.5, 5, '');
        $this->Cell(($this->psize/14)*6, 5,'1ª Testemunha', '');
        $this->Cell(($this->psize/14)*0.5, 5, '');
        $this->Cell(($this->psize/14)*0.5, 5, '');
        $this->Cell(($this->psize/14)*6, 5,'2ª Testemunha', '');
        $this->ln();
        $this->Cell(($this->psize/14)*0.5, 5, '');
        $this->Cell(($this->psize/14)*6, 5,'CPF:', '');
        $this->Cell(($this->psize/14)*0.5, 5, '');
        $this->Cell(($this->psize/14)*0.5, 5, '');
        $this->Cell(($this->psize/14)*6, 5,'CPF:', '');

	}
}
?>
