<?php

class FrmFileForStudentCard extends MForm
{

    /**
     * Class constructor
     **/
    function __construct($data=null)
    {
        $MIOLO           = MIOLO::getInstance();
        $module          = MIOLO::getCurrentModule();

        parent::__construct(_M('File for student card', $module) );

        $this->setHelp(get_class($this), MIOLO::getCurrentModule(), MIOLO::getCurrentAction());

        $this->eventHandler();
    }

    public function createFields()
    {
        $MIOLO     = MIOLO::getInstance();
        $module    = MIOLO::getCurrentModule();
        $action    = MIOLO::getCurrentAction();
        $function  = MIOLO::_request('function');
        $event     = MIOLO::_request('event');

        $toolBar = new MToolBar('toolBar',$MIOLO->getActionURL($module,$action));

		$toolBar->hideButton('tbBtnDelete');
   		$toolBar->hideButton('tbBtnSearch');
        $toolBar->hideButton('tbBtnSave');
		$toolBar->hideButton('tbBtnNew');
        $fields[] = $toolBar;
        $businessStudentCard = $MIOLO->getBusiness($module, 'BusStudentCard');
        $list = $businessStudentCard->listStudentCardList();
        $listForStudentCard = new MSelection('listForStudentCard', $this->getFormValue('listForStudentCard', $data->listForStudentCard), _M('Student card listing', $module), $list);
        $validators[] = new MRequiredValidator('listForStudentCard', _M('Student card listing',$module));
        $fields[] = $listForStudentCard;
        $fields[] = new Separator('');
        $divError = new MDiv('divError', null, null, 'align=center');
        $fields[] = $divError;

        
        $this->setFields($fields);
        $this->setValidators($validators);
        $this->setLabelWidth(FIELD_LABEL_SIZE);
		$this->setShowPostButton(false);
        $this->setClose($MIOLO->getActionURL($module,substr($action,0,strrpos($action,':'))));
    }

    public function tbBtnPrint_click($sender = null)
    {
		$MIOLO = MIOLO::getInstance();
		$module = MIOLO::getCurrentModule();
        $d = explode('|', $this->getFormValue('listForStudentCard'));
        $data->periodId     = $d[0];
        $data->listagemId    = $d[1];
        
		$businessStudent = $MIOLO->getBusiness($module, 'BusStudentCard');
		$dataX = $businessStudent->getPupils2($data);
		for($x = 0; $x < count($dataX); $x++)
		{
			$dataY[$x][] = str_pad(substr($dataX[$x][0],0,4),4,'0', STR_PAD_LEFT);
			$dataY[$x][] = str_pad(substr($dataX[$x][1],0,50),50,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][2],0,50),50,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][3],0,50),50,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][4],0,1),1,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][5],0,25),25,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][6],0,1),1,'0', STR_PAD_LEFT);
			$dataY[$x][] = str_pad(substr($dataX[$x][7],0,1),1,'0', STR_PAD_LEFT);
			$dataY[$x][] = str_pad(substr($dataX[$x][8],0,1),1,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][9],0,5),5,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][10],0,12),12,' ',STR_PAD_LEFT);
			$dataY[$x][] = str_pad(substr(str_replace('/','',$dataX[$x][11]),0,8),8,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][12],0,50),50,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][13],0,30),30,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][14],0,20),20,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][15],0,8),8, '0', STR_PAD_LEFT);
			$dataY[$x][] = str_pad(substr($dataX[$x][16],0,10),10,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][17],0,20),20,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][18],0,10),10,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][19],0,8),8,' ');
			$dataY[$x][] = str_pad(substr($dataX[$x][20],0,11),11,' ');
			$dataGrid[] = $dataX[$x];
			$fC .= implode($dataY[$x],'')."\n";
            $personIds[] = (int)$dataX[$x][21];
		}
        $f1 = 'semturList/'.'ARQUIVO_RETORNO_INS_'.$dataX[0][0].'_REM_'. $data->listagemId . '.txt';
        $data->file = $fC;
        $data->fileId = $f1;
        SAGUFile::saveDataToLocal($data);
		if( count($dataGrid) > 0 )
		{
			SAGU::returnAsFile($f1, $fC, 'text/card-file');
		}
    }
}
