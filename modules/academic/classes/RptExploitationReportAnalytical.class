<?
/**
*
* @author Giovani Murilo Dantas Correa [gmurilo@isolution.inf.br]
*
* $version: $Id$
*
* \b Maintainers \n
* Daniel Afonso Heisler [daniel@isolution.inf.br]
*
* @since
* Class created on 12/10/2009
*
* \b Organization: \n
* iSolution - Soluções de Internet \n
* The iSolution TEAM
*
* \b CopyLeft: \n
* CopyLeft (L) 2007 iSolution - Soluções de Internet \n
*
* \b License \n
* Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html )
*
* \b History \n
* See history in CVS repository: http://isolution.inf.br   
*
**/
set_time_limit(0);        
$MIOLO = MIOLO::getInstance();
$module = 'academic';

define('FPDF_FONTPATH', $MIOLO->getModulePath('basic', '/classes/fpdf/font/'));
$MIOLO->Uses('classes/fpdf/pdf.php', 'basic');

class RptExploitationReportAnalytical extends PDF
{
    var $module = 'academic';
    public function __construct($data = NULL)
    {
        $this->MIOLO = MIOLO::getInstance();
        $this->title = strtoupper(_M('Exploitation report', $this->module));
        parent::__construct();

        foreach($data as $item => $value)
        {
            $this->filters->{$item} = $value;
        }
        $this->useUserInfo = false;
        $this->addPage('P', 'mm', 'A4');
        $this->aliasNbPages(); 
        $this->putInfos();
        $this->outPut();
    } 
    
    public function putInfos()
    {
        $bus = $this->MIOLO->getBusiness('academic', 'BusExploitationReport');
        $this->data = $bus->getExploitations($this->filters);
        if ( count($this->data) == 0 )
        { 
            $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
            $this->setTextColor(255,0,0);
            $this->cell($this->psize, $this->lsize, strtoupper(_M('Not registers found for this process.', 'academic')), null, null, 'C', null, null);
            $this->ln();
            $this->setTextColor(0,0,0);
            $this->outPut();
            return;
        }
        $contractId = null;
        foreach ( $this->data as $item => $value )
        {
            if ( ($this->y+($this->lsize*2) > $this->PageBreakTrigger && $n < count($this->data)) || $contractId <> $item )
            {
                $contractId = $item;

                if( $n > 0 )
                {
                    $this->addPage('P', 'mm', 'A4');
                }
                $this->putHeader($value[0]);
            }
            unset($groupedResult);
            
            foreach ( $value as $x => $disciplina )
            {
                $groupedResult[$disciplina->serie]++;
                $groupedResult2[$disciplina->serie]++;
                $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
                $this->cell(($this->psize/6)*0.2,$this->lsize,  $x+1, 'TBLR', null, 'R');
                $this->cell(($this->psize/6)*3.4,$this->lsize,  $disciplina->curricularComponent, 'TBLR');
                $this->cell(($this->psize/6)*0.4,$this->lsize,  $disciplina->serie, 'TBR',null,  'C');
                $this->cell(($this->psize/6)*0.8,$this->lsize,  $disciplina->periodId, 'TBR',null,  'C');
                $this->cell(($this->psize/6)*1.2,$this->lsize,  _M($disciplina->exploitationType, 'academic') , 'TBR',null,  'C');
                $this->ln();
                if ( $this->filters->exploitationDetails )
                {
                    if ( $disciplina->exploitationType == 'Internal' )
                    {
                       $this->setFont(DEFAULT_REPORT_FONT, 'BI', 12);
                        $this->setTextColor(255,0,0);
                        $this->cell(5, $this->lsize, chr(164), 'LTB' );
                        $this->setFont(DEFAULT_REPORT_FONT, 'I', 7);
                        $this->setTextColor(95,95,95);
                        $this->cell(20, $this->lsize, strtoupper(_M('Course', 'academic')). ': ' , 'TB');
                        $this->cell($this->psize -25, $this->lsize, $disciplina->exploitationCourseName, 'RTB');
                        $this->ln();
                        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 12);
                        $this->setTextColor(255,0,0);
                        $this->cell(5, $this->lsize, chr(164), 'LTB' );
                        $this->setFont(DEFAULT_REPORT_FONT, 'I', 7);
                        $this->setTextColor(95,95,95);
                        $this->cell(20, $this->lsize, strtoupper(_M('Curricular component', 'academic')). ': ' , 'TB');
                        $this->cell(($this->psize/6)*3.8 -25, $this->lsize, $disciplina->exploitationCurricularComponent, 'RTB');
                        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 12);
                        $this->setTextColor(255,0,0);
                        $this->cell(5, $this->lsize, chr(164), 'LTB' );
                        $this->setFont(DEFAULT_REPORT_FONT, 'I', 7);
                        $this->setTextColor(95,95,95);
                        $this->cell(20, $this->lsize, strtoupper(_M('Final note', 'academic')). ': ' , 'TB');
                        $this->cell(($this->psize/6)*1.2 -25, $this->lsize, SAGU::formatNumber($disciplina->exploitationFinalNote), 'RTB');
                        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 12);
                        $this->setTextColor(255,0,0);
                        $this->cell(5, $this->lsize, chr(164), 'LTB' );
                        $this->setFont(DEFAULT_REPORT_FONT, 'I', 7);
                        $this->setTextColor(95,95,95);
                        $this->cell(20, $this->lsize, strtoupper(_M('Serie', 'academic')). ': ' , 'TB');
                        $this->cell(($this->psize/6) -25, $this->lsize, $disciplina->exploitationSerie, 'TBR');
                        $this->ln();
                     }
                    else
                    {
                        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 12);
                        $this->setTextColor(255,0,0);
                        $this->cell(5, $this->lsize, chr(164), 'LTB' );
                        $this->setFont(DEFAULT_REPORT_FONT, 'I', 7);
                        $this->setTextColor(95,95,95);
                        $this->cell(20, $this->lsize, strtoupper(_M('Institution', 'academic')). ': ' , 'TB');
                        $this->cell($this->psize -25, $this->lsize, $disciplina->institutionName, 'TBR');
                        $this->ln();
                        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 12);
                        $this->setTextColor(255,0,0);
                        $this->cell(5, $this->lsize, chr(164), 'LTB' );
                        $this->setFont(DEFAULT_REPORT_FONT, 'I', 7);
                        $this->setTextColor(95,95,95);
                        $this->cell(20, $this->lsize, strtoupper(_M('Course', 'academic')). ': ' , 'TB');
                        $this->cell($this->psize -25, $this->lsize, $disciplina->exploitationCourseName, 'RTB');
                        $this->ln();
                        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 12);
                        $this->setTextColor(255,0,0);
                        $this->cell(5, $this->lsize, chr(164), 'LTB' );
                        $this->setFont(DEFAULT_REPORT_FONT, 'I', 7);
                        $this->setTextColor(95,95,95);
                        $this->cell(20, $this->lsize, strtoupper(_M('Curricular component', 'academic')). ': ' , 'TB');
                        $this->cell((($this->psize/4)*3) -25, $this->lsize, $disciplina->exploitationCurricularComponent, 'RTB');
                        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 12);
                        $this->setTextColor(255,0,0);
                        $this->cell(5, $this->lsize, chr(164), 'LTB' );
                        $this->setFont(DEFAULT_REPORT_FONT, 'I', 7);
                        $this->setTextColor(95,95,95);
                        $this->cell(20, $this->lsize, strtoupper(_M('Final note', 'academic')). ': ' , 'TB');
                        $this->cell(($this->psize/4) -25, $this->lsize, SAGU::formatNumber($disciplina->exploitationFinalNote), 'RTB');
                        $this->ln();
                    }
                }
                $this->setTextColor(0,0,0);
            }
            $this->ln();
            if ( count($groupedResult) > 0 )
            {
                foreach ( $groupedResult as $serie => $total )
                {
                    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
                    $this->cell($this->psize-10 , $this->lsize, strtoupper(_M('Serie', 'academic')). ' ( '.$serie.' ): ' , null, null, 'R');
                    $this->setFont(DEFAULT_REPORT_FONT, '', 8);
                    $this->cell(10, $this->lsize, $total, null, null, 'R');
                    $this->ln();

                }
                $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
                $this->cell($this->psize-10 , $this->lsize, strtoupper('Total') .': ', null, null, 'R');
                $this->setFont(DEFAULT_REPORT_FONT, '', 8);
                $this->cell(10, $this->lsize, array_sum($groupedResult), null, null, 'R');
                $this->ln();
            }
            $n++;
        }
        $this->personName = NULL;
        $this->title .= ' TOTAL';
        $this->addPage('P', 'mm', 'A4');

        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
        $this->cell($this->psize-10 , $this->lsize, strtoupper(_M('Pupils total', 'academic')) .': ', null, null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, '', 8);
        $this->cell(10, $this->lsize, $n, null, null, 'R');
        $this->ln();
        $this->ln();

        if ( count($groupedResult2) > 0 )
        {
            foreach ( $groupedResult2 as $serie => $total )
            {
                $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
                $this->cell($this->psize-10 , $this->lsize, strtoupper(_M('Serie', 'academic')). ' ( '.$serie.' ): ' , null, null, 'R');
                $this->setFont(DEFAULT_REPORT_FONT, '', 8);
                $this->cell(10, $this->lsize, $total, null, null, 'R');
                $this->ln();

            }
            $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
            $this->cell($this->psize-10 , $this->lsize, strtoupper('Total') .': ', null, null, 'R');
            $this->setFont(DEFAULT_REPORT_FONT, '', 8);
            $this->cell(10, $this->lsize, array_sum($groupedResult2), null, null, 'R');
            $this->ln();
        }
    }

    public function putHeader($header)
    {
        $this->fontSizeBody = $this->fontSizeBody;
        $this->personName = $header->personName;
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell(($this->psize/12)*0.7,$this->lsize,  _M('Pupil','academic'). ':', 'LT', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell(($this->psize/12)*6.6, $this->lsize, $header->personName, 'T');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell(($this->psize/12)*0.8,$this->lsize,  _M('Contract','academic'). ':', 'T', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell(($this->psize/12)*1.3, $this->lsize, $header->contractId, 'T', null, 'L');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell(($this->psize/12)*1.6, $this->lsize, _M('Person id', 'basic') .':', 'T', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell(($this->psize/12)*1, $this->lsize,   $header->personId, 'RT', null, 'R');
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell(($this->psize/12)*0.7,$this->lsize,  _M('Course','academic'). ':', 'LB',null,  'R');
        if(strlen((string)$header->courseName) > 25 )
        {
            $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody-1);
        }
        else
        {
            $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        }
        $this->cell(($this->psize/12)*3.2, $this->lsize, $header->courseName, 'B');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell(($this->psize/12)*0.7, $this->lsize, _M('Class', 'academic') .':', 'B');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell(($this->psize/12)*2.6, $this->lsize,   $header->class, 'B');
        
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell(($this->psize/12)*0.7, $this->lsize, _M('Turn', 'basic') .':', 'B');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell(($this->psize/12)*2.1, $this->lsize,   $header->turn, 'B');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell(($this->psize/12)*1, $this->lsize, _M('Emission date', 'academic') .':', 'B', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell(($this->psize/12)*1, $this->lsize,   date('d/m/Y'), 'RB', null, 'R');
        $this->ln();
        $this->fontSizeBody = $this->fontSizeBody-1;
        $this->ln($this->lsize/2);
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell(($this->psize/6)*0.2,$this->lsize,  'N.', 1,null,  'C');
        $this->cell(($this->psize/6)*3.4,$this->lsize,  _M('Curricular component','academic'), 'TBLR');
        $this->cell(($this->psize/6)*0.4,$this->lsize,  _M('Serie','academic'), 'TBR',null,  'C');
        $this->cell(($this->psize/6)*0.8,$this->lsize,  _M('Period','academic'), 'TBR',null,  'C');
        $this->cell(($this->psize/6)*1.2,$this->lsize,  _M('Type','academic'), 'TBR',null,  'C');
        $this->ln();
    }
    public function Footer()
    {
        $this->setY(-15);
        $this->setTextColor(0,0,0);
        $this->Line($this->x, $this->y, $this->psize+$this->lMargin, $this->y);
        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
        $this->cell($this->psize, $this->lsize, $this->personName, null, null, 'C');
        $this->ln();
        $pn = $this->PageNo();
        if($this->AutoPageBreak)
        {
            $pn .='/{nb}';
        }
		$this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
		$this->cell($this->psize/2, $this->lsize, $this->title, 0, 0, 'L');
   		$this->setFont(DEFAULT_REPORT_FONT, 'I', 8);
		$this->cell($this->psize/2, $this->lsize, _M('Page @1', 'basic', $pn), 0, 0, 'R');
        $this->ln();
    }
}
?>
