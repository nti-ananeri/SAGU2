<?php

define('FPDF_FONTPATH', $MIOLO->getModulePath('basic', '/classes/fpdf/font/'));

$MIOLO = MIOLO::getInstance();
$MIOLO->Uses('classes/fpdf/pdf.php', 'basic');

class RptStudentCardSheet extends PDF
{
    var $module = 'academic';
    public function __construct($data = NULL)
    {
        $MIOLO = MIOLO::getInstance();
        $this->db = $MIOLO->getBusiness('academic', 'BusStudentCard');
        $this->title = strtoupper(_M(" ", $this->module));
        parent::__construct();
        $this->defaultFontSize = 8;
        foreach ($data as $item=> $value)
        {
            $this->loadValue->{$item} = $value;
        }
        $this->useUserInfo = true;
        $this->addPage('P', 'mm', 'A4');
        $this->aliasNbPages();
        $this->putHeaderLine();
        $this->outPut();
    }
    
    public function putHeaderLine()
    {
        $this->getInfo();
        $this->putHeader();
        $this->putContent();
    }

    public function getInfo()
    {
        $this->pupils = $this->db->getPupilsFromList($this->loadValue);
    }

    public function putContent()
    {
        if( count($this->pupils) > 0 )
        {
            $x=0;
            foreach ($this->pupils as $pupil )
            {
                $x++;
                $this->setFont(DEFAULT_REPORT_FONT, '', 7);         
                $this->cell(($this->psize/7)*3, $this->lsize, $pupil->name, 1, null, 'L');
                $this->cell(($this->psize/7)*0.5, $this->lsize, $pupil->birthDate, 1, null, 'C');
                $this->cell(($this->psize/7)*3, $this->lsize, $pupil->courseName, 1, null, 'L');
                $this->cell(($this->psize/7)*0.5, $this->lsize, $pupil->charId, 1, null, 'C');
                $this->ln();
                $this->totalAlunos = $x; 
                if ( $this->y+$this->lsize > $this->PageBreakTrigger )
                {
                    $this->putHeader();
                    $x = 0;
                }
            }
            $this->ln();
            $this->setFont(DEFAULT_REPORT_FONT, 'BI', $this->defaultFontSize);         
            $this->cell($this->psize, $this->lsize, 'TOTAL DE ALUNOS: '. count($this->pupils), null, null, 'R');
        }
    }

    public function putHeader()
    {
             
        
        $this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
        $this->cell($this->psize, $this->lsize, strtoupper('SECRETARIA MUNICIPAL DE TRÂNSITO E TRANSPORTES - SMMT'), null, null, 'C');
        $this->ln();
        
        $this->setFont(DEFAULT_REPORT_FONT, '', 8);
        $this->cell($this->psize, $this->lsize, strtoupper('COORDENAÇÃO GERAL DE ATENDIMENTO AO ESTUDANTE'), null, null, 'C');
        $this->ln();

        $this->setFont(DEFAULT_REPORT_FONT, '', 8);
        $this->cell($this->psize, $this->lsize, strtoupper('NUMERO DA REMESSA:'). ' ' . $this->loadValue->listagemId, null, null, 'R');
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, '', 8);
        $this->cell($this->psize, $this->lsize, strtoupper('ANO/SEMESTRE:'). ' ' . str_replace('.', '/', $this->loadValue->periodId), null, null, 'R');
        $this->ln();
//        $this->line();
        $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
        $this->cell($this->psize, $this->lsize, strtoupper('RELAÇÃO SIMPLIFICADA DE ESTUDANTES'), null, null, 'C');
        $this->ln();
        $this->ln();

        $this->SetFillColor(180,180,180);
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize/7)*3, $this->lsize, strtoupper(_M('Full name', $this->module)), 1, null, 'L', 1);
        $this->cell(($this->psize/7)*0.5, $this->lsize, strtoupper(_M('Nasc', $this->module)), 1, null, 'C', 1);
        $this->cell(($this->psize/7)*3, $this->lsize, strtoupper(_M('Course', $this->module)), 1, null, 'L', 1);
        $this->cell(($this->psize/7)*0.5, $this->lsize, strtoupper(_M('Turn', $this->module)), 1, null, 'C', 1);
        $this->ln();

    }

    public function Footer()
    {
        $this->setY(-15);
        $pn = $this->PageNo();
        $this->cell($this->psize, $this->lsize, '', 'B', 1);
        $this->ln(); 
		$this->setFont(DEFAULT_REPORT_FONT, '', 8);
		$this->cell(($this->psize/2), $this->lsize, 'TOTAL DE ALUNOS DA PÁGINA: '. str_pad($this->totalAlunos, 2, 0, STR_PAD_LEFT),  0, 0, 'L');
   		$this->cell(($this->psize/2), $this->lsize, strtoupper(_M('Page @1', $this->module, ': ' .str_pad($pn,3,0,STR_PAD_LEFT))), 0, 0, 'R');
        $this->ln();
    }
}
?>
