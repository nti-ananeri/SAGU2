<?php
/**
 *
 * Handles external exploitation data
 *
 * @author Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 *
 * $version: $Id$
 *
 * \b Maintainers \n
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Armando Taffarel Neto [taffarel@solis.coop.br]
 * Leovan Tavares da Silva [leovan@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 * 
 * @since
 * Class created on 23/09/2005
 *
 * \b @organization \n
 * SOLIS - Cooperativa de Soluções Livres \n
 * The Sagu2 development team
 *
 * \b Copyleft \n
 * Copyleft (L) 2005 - SOLIS - Cooperativa de Soluções Livres \n
 *
 * \b License \n
 * Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html )
 *
 * \b History \n
 * See history in CVS repository: http://sagu.solis.coop.br   
 *
 **/
$MIOLO = MIOLO::getInstance();
$MIOLO->uses('db/BusExploitation.class', 'academic');
/**
 * Class to manipulate the external exploitation data of acdExploitation table
 **/
class BusinessAcademicBusExternalExploitation extends BusinessAcademicBusExploitation
{

    /**
     * Class constructor
     **/
    public function __construct()
    {
        parent::__construct();
    }
    
    /**
     * Gets an object that represents the external exploitation data
     *
     * @param $exploitationId: Primary key of the desired register
     *
     * @return (object): An object containing the data
     **/
    public function getExternalExploitation($exploitationId)
    {
        $sql = 'SELECT exploitationId,
                       enrollId,
                       exploitationType,
                       exploitationNumberHours,
                       exploitationCredits,
                       institutionId,
                       courseName,
                       curricularComponentName,
                       finalNote,
                       numberHours,
                       credits,
                       period
                  FROM acdExploitation
                 WHERE exploitationId = ?';
                 
        $args = array($exploitationId);
        
        $result = $this->db->query(SAGU::prepare($sql, $args));
        
        list ($exploitationData->exploitationId,
              $exploitationData->enrollId,
              $exploitationData->exploitationType,
              $exploitationData->exploitationNumberHours,
              $exploitationData->exploitationCredits,
              $exploitationData->institutionId,
              $exploitationData->courseName,
              $exploitationData->curricularComponentName,
              $exploitationData->finalNote,
              $exploitationData->numberHours,
              $exploitationData->credits,
              $exploitationData->period) = $result[0];
              
        return $exploitationData;
    }
    
    /**
     * Searches for external exploitation data on acdExploitation table
     *
     * @param $filters (object): Search filters
     *
     * @return (array): An array containing the search results
     **/
    public function seachExternalExploitation($filters)
    {
        $sql = 'SELECT A.exploitationId,
                       A.exploitationType,
                       A.enrollId,
                       D.curricularComponentId || \'/\' || D.curricularComponentVersion,
                       D.name,
                       A.institutionId,
                       E.name,
                       A.courseName,
                       A.curricularComponentName,
                       A.finalNote,
                       A.numberHours,
                       A.credits,
                       A.period,
                       A.exploitationNumberHours,
                       A.exploitationCredits,
                       F.periodId
                  FROM acdExploitation A
            INNER JOIN acdEnroll B
                    ON (B.enrollId = A.enrollId)
            INNER JOIN acdCurriculum C
                    ON (C.curriculumId = B.curriculumId)
            INNER JOIN acdCurricularComponent D
                    ON (D.curricularComponentId = C.curricularComponentId AND
                        D.curricularComponentVersion = C.curricularComponentVersion)
            INNER JOIN basLegalPerson E
                    ON (E.personId = A.institutionId)
            INNER JOIN acdLearningPeriod F
                    ON (F.learningPeriodId = B.learningPeriodId)';
                    
        unset($where);
        if (strlen((string)$filters->exploitationId) > 0)
        {
            $where .= ' AND A.exploitationId = ?';
            $args[] = $filters->exploitationId;
        }
        if (strlen((string)$filters->exploitationType) > 0)
        {
            $where .= ' AND A.exploitationType = ?';
            $args[] = $filters->exploitationType;
        }
        if (strlen((string)$filters->enrollId) > 0)
        {
            $where .= ' AND A.enrollId = ?';
            $args[] = $filters->enrollId;
        }
        if (strlen((string)$filters->curricularComponentId) > 0)
        {
            $where .= ' AND D.curricularComponentId = ?';
            $args[] = $filters->curricularComponentId;
        }
        if (strlen((string)$filters->curricularComponentName) > 0)
        {
            $where .= ' AND TO_ASCII(D.name) ILIKE TO_ASCII(?)';
            $args[] = $filters->curricularComponentName;
        }
        if (strlen((string)$filters->periodId) > 0)
        {
            $where .= ' AND F.periodId = ?';
            $args[] = $filters->periodId;
        }
        if (strlen((string)$filters->contractId) > 0)
        {
            $where .= ' AND B.contractId = ?';
            $args[] = $filters->contractId;
        }
        
        unset($result);
        if ( strlen((string)$where) > 0 )
        {
            $sql .= ' WHERE ' . substr($where, 4) . '
                   ORDER BY A.period, D.name';

            $result = $this->db->query(SAGU::prepare($sql, $args));
        }
    }
    
    /**
     * Inserts a external exploitation register on the exploitations table
     *
     * @param $data (object): Object with the data to be inserted
     *
     * @return True if succed, otherwise False
     **/
    public function insertExternalExploitation($data)
    {
        /**
         * Atributos do objeto $data
         * $data->contractId: código do contrato
         * $data->curriculumId: código da disciplina na matriz curricular
         * $data->institutionId: código da instituição onde a disciplina aproveitada foi cursada
         * $data->courseName: curso da disciplina aproveitada
         * $data->curricularComponentName: disciplina aproveitada
         * $data->finalNote: grau obtido na disciplina aproveitada
         * $data->numberHours: carga horária total da disciplina aproveitada
         * $data->credits: número de créditos total da disciplina aproveitada
         * $data->period: período em que a disciplina aproveitada foi cursada
         * $data->exploitationNumberHours: número de horas aproveitadas
         * $data->exploitationCredits: número de créditos aproveitados
         * $data->periodId: código do período do aproveitamento
         **/
        
        $transaction = $this->db->getTransaction();
        $transaction->_beginTransaction();
        
        $data->exploitationType = 'E';
        $data->enrollId         = $this->getEnrollForExploitation($data->contractId, $data->curriculumId, $data->periodId);
        
        $sql = 'INSERT INTO acdExploitation
                           (enrollId,
                            exploitationType,
                            exploitationNumberHours,
                            exploitationCredits,
                            institutionId,
                            courseName,
                            curricularComponentName,
                            finalNote,
                            numberHours,
                            credits,
                            period)
                     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)';
                     
        $args = array($data->enrollId,
                      $data->exploitationType,
                      $data->exploitationNumberHours,
                      $data->exploitationCredits,
                      $data->institutionId,
                      $data->courseName,
                      $data->curricularComponentName,
                      $data->finalNote,
                      $data->numberHours,
                      $data->credits,
                      $data->period);
        
        $this->db->execute(SAGU::prepare($sql, $args));
        
        return $transaction->_commit();
    }
    
    /**
     * Updates a external exploitation register of the exploitations table
     *
     * @param $data (object): Object with the data to be updated
     *
     * @return True if succed, otherwise False
     **/
    public function updateExternalExploitation($data)
    {
        /**
         * Atributos do objeto $data
         * $data->exploitationId: código do aproveitamento
         * $data->exploitationNumberHours: número de horas aproveitadas
         * $data->exploitationCredits: número de créditos aproveitados
         * $data->institutionId: código da instituição onde a disciplina aproveitada foi cursada
         * $data->courseName: curso da disciplina aproveitada
         * $data->curricularComponentName: disciplina aproveitada
         * $data->finalNote: grau obtido na disciplina aproveitada
         * $data->numberHours: carga horária total da disciplina aproveitada
         * $data->credits: número de créditos total da disciplina aproveitada
         * $data->period: período em que a disciplina aproveitada foi cursada
         **/
        
        $sql = 'UPDATE acdExploitation
                   SET exploitationNumberHours = ?,
                       exploitationCredits = ?,
                       institutionId = ?,
                       courseName = ?,
                       curricularComponentName = ?,
                       finalNote = ?,
                       numberHours = ?,
                       credits = ?,
                       period = ?
                 WHERE exploitationId = ?';
                 
        $args = array($data->exploitationNumberHours,
                      $data->exploitationCredits,
                      $data->institutionId,
                      $data->courseName,
                      $data->curricularComponentName,
                      $data->finalNote,
                      $data->numberHours,
                      $data->credits,
                      $data->period,
                      $data->exploitationId);
                      
        return $this->db->execute(SAGU::prepare($sql, $args));
    }
    
    /**
     * Searches for curriculums that can have exploitations registered (by contract)
     *
     * @param $contractId: Contract code
     *
     * @return (array): Array with the search results
     **/
    public function searchContractExploitableCurriculum($contractId)
    {
        $sql = 'SELECT A.curriculumId,
                       A.curricularComponentId || \'/\' || A.curricularComponentVersion,
                       B.name AS curricularComponentName,
                       B.academicNumberHours,
                       (SELECT CASE WHEN 
                                            sum(YY.exploitationNumberHours) > 0
                                    THEN
                                            sum(YY.exploitationNumberHours)
                                    ELSE
                                            0
                                    END
                          FROM acdExploitation YY
                    INNER JOIN acdEnroll ZZ
                            ON (ZZ.enrollId = YY.enrollId)
                         WHERE ZZ.contractId = C.contractId
                           AND ZZ.curriculumId = A.curriculumId) AS exploitedNumberHours,
                       A.semester
                  FROM acdCurriculum A
            INNER JOIN acdCurricularComponent B
                    ON (B.curricularComponentId = A.curricularComponentId AND
                        B.curricularComponentVersion = A.curricularComponentVersion)
            INNER JOIN acdContract C
                    ON (C.courseId = A.courseId AND
                        C.courseVersion = A.courseVersion AND
                        C.turnId = A.turnId AND
                        C.unitId = A.unitId)
                 WHERE C.contractId = ?
                   AND ( A.curriculumId NOT IN ( SELECT YZ.curriculumId 
                                                   FROM acdEnroll YZ
                                                  WHERE YZ.statusId IN ('.ENROLL_STATUS_APPR_OR_EXC.', '.ENROLL_STATUS_ENROLLED.') 
                                                    AND YZ.contractId = C.contractId ) ';
                   
        //verifica carga horária - aproveitamentos
        $sql .= 'OR B.academicNumberHours > (SELECT CASE WHEN 
                                                           sum(XY.exploitationNumberHours) > 0
                                                           THEN
                                                           sum(XY.exploitationNumberHours)
                                                           ELSE
                                                           B.academicNumberHours
                                                           END
                                                      FROM acdExploitation XY
                                                INNER JOIN acdEnroll XZ
                                                        ON (XZ.enrollId = XY.enrollId)
                                                     WHERE XZ.contractId = C.contractId
                                                       AND XZ.curriculumId = A.curriculumId) ';
                                                     
        $sql .= ') ';//fecha o parenteses antes de D.statusId NOT IN...
        
        //verifica concorrências
        $sql .= ' AND A.curriculumId NOT IN (SELECT CD.curriculumId 
                                                FROM acdCurriculum CD 
                                               WHERE CD.courseId = A.courseId
                                                 AND (CD.curriculumId IN 
                                                          (SELECT CR.curriculumInId 
                                                             FROM acdCurriculumConcurrence CR 
                                                            WHERE CR.curriculumOutId IN (
                                                                     SELECT CE.curriculumId 
                                                                       FROM acdEnroll CE 
                                                                      WHERE CE.contractId = C.contractId
                                                                        AND CE.statusId IN ('.ENROLL_STATUS_APPR_OR_EXC.')) ';
        $sql .= ' ) '; //fecha o parentes antes de CD.curriculumId IN
        
        $sql .= 'OR CD.curriculumId IN (SELECT CS.curriculumOutId 
                                          FROM acdCurriculumConcurrence CS 
                                         WHERE CS.curriculumInId IN (
                                                               SELECT CF.curriculumId 
                                                                 FROM acdEnroll CF
                                                                WHERE CF.contractId = C.contractId
                                                                  AND CF.statusId IN ('.ENROLL_STATUS_APPR_OR_EXC.'))'; //fim da verificação de concorrências
                                                                  
        $sql .= ' ) ';//fecha o parenteses apos OR CD.curriculumId IN
        
        $sql .= ' ) ';//fecha o parenteses apos AND (CD.curriculumId IN
        
        $sql .= ' ) ';//fecha o parentes apos AND A.curriculumId NOT IN
        
        $sql .= ' AND A.curriculumTypeId NOT IN ('. ACD_CURRICULUM_TYPE_OPTATIVE .', ' .  ACD_CURRICULUM_TYPE_COMPLEMENTARY_ACTIVITY . ',' . ACD_CURRICULUM_TYPE_PROFICIENCY . ') ';
        
        $sql .= 'ORDER BY A.semester,
                          B.name';

        $args = array($contractId);

        return $this->db->query(SAGU::prepare($sql, $args));
    }
}

?>
