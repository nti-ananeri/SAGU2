<?php

class bank237 extends boletoFunctions
{
    var $nossoNumero;
    var $codigoBarras;
    var $linhaDigitavel;
    var $carteira;
    var $dvCodigoBanco;
    var $cip;
    var $usoBanco;
    var $especieDocumento;
    var $cedente;
    var $sacadoAvalista;
    var $sacadoAvalistaCpf;


    public function __construct ( $data )
    {
        $codigoBanco = '237';
        $codigoMoeda = '9';
        $fatorVencimento = $this->fator_vencimento($data->maturityDate);
        $valorDocumento = $this->formata_numero($data->invoiceValue,10,0,"valor");
        
        $this->carteira = $data->wallet;
        
        $this->dvCodigoBanco= $this->geraCodigoBanco($codigoBanco);
        $data->branch       = $this->formata_numero($data->branchNumber, 4, 0, "valor");
        $data->account      = $this->formata_numero($data->accountNumber, 7, 0, "valor");

        switch ( $data->variation )
        {
            case 2: //Bic
                $data->nossoNumero  = $this->formata_numero($data->bankInvoiceId, 6, 0, "valor");
                $campoLivre  = $data->branch;
                $campoLivre .= $data->wallet;
                $campoLivre .= '42'; //Radical
                $campoLivre .= '014'; //Matricula
                $campoLivre .= $data->nossoNumero;
                $campoLivre .= $data->account;
                $campoLivre .= '0';
                $this->cip = '521';
                $this->usoBanco = 'EXPRESSA';
                $this->especieDocumento = 'MS';
                $this->cedente = 'BANCO INDUSTRIAL E COMERCIAL BICBANCO';
                $this->sacadoAvalista = $data->companyName . ' END: AV. SÃO LUÍS REI DE FRANÇA N 32 - TURU ';
                $this->sacadoAvalistaCpf = $data->cnpj;
                break;
            default:
                $data->nossoNumero  = $this->formata_numero($data->bankInvoiceId, 11, 0, "valor");
                $campoLivre  = $data->branch;
                $campoLivre .= $data->wallet;
                $campoLivre .= $data->nossoNumero;
                $campoLivre .= $data->account;
                $campoLivre .= '0';
                $this->especieDocumento = 'DM';
                break;
        }
        $data->nossoNumero = $data->wallet . ' / '. substr($campoLivre, 6, 11) .'-'. $this->digitoVerificador_nossonumero($data->wallet.substr($campoLivre, 6, 11));
        $dvGeral                    = $this->digitoVerificador_barra("$codigoBanco$codigoMoeda$fatorVencimento$valorDocumento$campoLivre");

        $this->codigoBarras         =   "$codigoBanco$codigoMoeda$dvGeral$fatorVencimento$valorDocumento$campoLivre";
        $this->linhaDigitavel       =   $this->monta_linha_digitavel($this->codigoBarras);
        $this->nossoNumero          =   $data->nossoNumero;
        $this->agenciaCodigoCedente =   $data->branchNumber . " / " . $data->accountNumber . '-' . $data->accountNumberDigit;
    }
    
    public function digitoVerificador_nossonumero($numero) 
    {
        $resto2 = $this->modulo_11($numero, 7, 1);
        $digito = 11 - $resto2;
        if ($digito == 10) 
        {
            $dv = "P";
        } 
        elseif($digito == 11) 
        {
            $dv = 0;
        } 
        else 
        {
            $dv = $digito;
        }
        return $dv;
    }
}
?>
