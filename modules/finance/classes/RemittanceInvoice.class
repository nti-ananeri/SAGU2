<?php
$MIOLO->getClass('finance', 'DefaultFormat');
/**
 * Class to generate the bank remittance
 */
class RemittanceInvoice
{
    /**
     * Returns if the specific bank id have remittance class
     *
     * @param: $bankId (identification for bank)
     * 
     * @return: (boolean) True if exists otherwise false
     *
     */

    public function __construct($data)
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $header = $this->header($data);
        $details = $this->details($data);
        $trailler = $this->trailler();

        $fileBody = $header;
        $fileBody .= $details;
        $fileBody .= $trailler;
        // Grava arquivos na base
        $businessFile = $MIOLO->getBusiness($module, 'BusFile');
        $fileData->fileName = 'remessaBanco'. $data->bankId .date(dmy). '.txt';
        $fileData->file     = $fileBody;
        $fileData->bankAccountId = $data->bankAccountId;
        $fileData->fileType = 'I';
        $fileData->inputOrOutput = 'O';
        $fileData->isProcessed = DB_TRUE;
        $fileData = $businessFile->insertFinanceFile($fileData);
        $this->fileData = $fileData;
        $this->updateInvoicesRemittanceField($data);
        SAGU::returnAsFile($fileData->fileName, $fileBody, 'text/remittance');
    }

    public function modulo_11($num, $base=9, $r = 0)
    {
        $fator = 2;
        $soma = array();
        /* Separacao dos numeros */
        for ($i = strlen((string)$num); $i > 0; $i--)
        {
            // pega cada numero isoladamente
            // Efetua multiplicacao do numero pelo falor
            $soma[] = substr($num,$i-1,1) * $fator;
            if ($fator == $base)
            {
                // restaura fator de multiplicacao para 2
                $fator = 1;
            }
            $fator++;
        }
        if ( $r == 0 )
        {
            $soma2 = array_sum($soma)*10;
            $digito = $soma2 % 11;
            if ( $digito == 10 )
            {
                $digito = 0;
            }
        }
        else if ( $r == 1 )
        {
            $digito = array_sum($soma) % 11;
        }
        return $digito;
    }
}
?>
