<?php

/**
 *
 * This file handles the connection and actions for finBank table
 *
 * @author Giovani Murilo Dantas Correa [gmurilo@gmail.com]
 *
 * $version: $Id$
 *
 * \b Maintainers \n
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Daniel Afonso Heisler [daniel@solis.coop.br]
 * Jamiel Spezia [jamiel@solis.coop.br]
 * Rafael Lu�s Spengler [rafael@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 * Eduardo Beal Miglioransa [eduardo@solis.coop.br]
 *
 * @since
 * Class created on 18/10/2007
 *
 * \b Organization: \n
 * iSolution - Solu��es de Internet \n
 * The iSolution TEAM
 *
 * \b CopyLeft: \n
 * CopyLeft (L) 2007 iSolution - Solu��es de Internet \n
 *
 * \b License \n
 * Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html )
 *
 * \b History \n
 * See history in CVS repository: http://isolution.inf.br
 *
 **/

define('FPDF_FONTPATH', $MIOLO->getModulePath('basic', '/classes/fpdf/font/'));

$MIOLO = MIOLO::getInstance();
$module = 'finance';
$MIOLO->Uses('classes/fpdf/pdf.php', 'basic');


class RptFinancialBalance extends PDF
{

  public function __construct($filters)
  {
    $this->MIOLO  = MIOLO::getInstance();
    $this->useUserInfo = false;
    $this->title = strtoupper(_M('Financial Balance', 'finance'));
    parent::__construct();
    $this->addPage('P', 'mm', 'A4');
    $this->aliasNbPages();
    $this->generatePDF($filters);
    $this->output();
  }

  public function generatePDF($filters)
  {
    $module = 'finance';
    $bPerson = $this->MIOLO->getBusiness('basic','BusPhysicalPerson');
    $dataP	 = $bPerson->getPhysicalPerson($filters->personId);
    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
    $this->cell(20, 8, _M('Name',$module).': ','','L',null);
    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
    $this->cell(100, 8,$dataP->name,'','L',null);
    $this->cell(70, 8,_M('Person id','basic').': '.$dataP->personId,'','L',null);
    $this->ln();
    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
    $this->cell(20, 8, _M('CPF',$module).': ','','L',null);
    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
    $this->cell(100, 8,substr($dataP->cpf,0,3).'.'.substr($dataP->cpf,3,3).'.'.substr($dataP->cpf,6,3).'-'.substr($dataP->cpf,9,2),'','L',null);
    $bClass      = $this->MIOLO->getBusiness('academic','BusClassPupil');
    $dataClass	 = $bClass->getClassFromPupil($filters->personId);
    //echo '<pre>'; print_r($dataClass); echo '<br>'; echo $dataClass[0][0]; die();
    $this->cell(70, 8,_M('Class','academic').': '.$dataClass[0][0],'','L',null);
    $this->ln();

    $this->fontSizeBody = 8;
    $this->colsize[0] = 6;
    $this->colsize[2] = 16;
    $this->colsize[3] = $this->colsize[2];
    $this->colsize[4] = $this->colsize[2];
    $this->colsize[5] = $this->colsize[2];
    $this->colsize[6] = $this->colsize[2];
    $this->colsize[7] = $this->colsize[2];
    $this->colsize[8] = $this->colsize[2];
    $this->colsize[9] = $this->colsize[2];
    $this->colsize[1] = ($this->psize-array_sum($this->colsize));


    $this->colname[0] = _M('Ref', $module);
    $this->colname[1] = _M('Operation', $module);
    $this->colname[2] = _M('Value', $module);
    $this->colname[3] = _M('Payed value', $module);
    $this->colname[4] = _M('Fine', $module);
    $this->colname[5] = _M('Juros', $module);
    $this->colname[6] = _M('Balance', $module);
    $this->colname[7] = _M('Discount', $module);
    $this->colname[8] = _M('Vencimento', $module);
    $this->colname[9] = _M('Payment', $module);

    for($x = 0; $x < count($this->colsize); $x++)
    {
      $this->setFont(DEFAULT_REPORT_FONT, 'B', (strlen((string)$this->colname[$x])/.5) <= ceil($this->colsize[$x]) ? $this->fontSizeBody : ceil($this->colsize[$x]/(strlen((string)$this->colname[$x])/4.5)) );
      $this->cell($this->colsize[$x], $this->lsize, $this->colname[$x], 1, NULL, 'C');
    }
    $this->ln();

    /*        $this->cell(18, 6, _M('Ref', $module), 1, 0, 'C');
     $this->cell(50, 6, _M('Operation', $module), 1, 0, 'L');
     $this->cell(18, 6, _M('Value', $module), 1, 0, 'C');
     $this->cell(18, 6, _M('Payed value', $module), 1, 0, 'C');
     $this->cell(18, 6, _M('Balance', $module), 1, 0, 'C');
     $this->cell(18, 6, _M('Fine', $module), 1, 0, 'C');
     $this->cell(18, 6, _M('Discount', $module), 1, 0, 'C');
     $this->cell(28, 6, _M('Maturity date', $module), 1, 0, 'C'); */
    $this->setFont(DEFAULT_REPORT_FONT, null, 8);
    $bFinancialBalance = $this->MIOLO->getBusiness('finance', 'BusFinancialBalance');
    $invoices = $bFinancialBalance->getInvoices($filters);
    $totais = array();
    unset($totais);
    $totais['value']=0;
    $totais['payedValue']=0;
    $totais['fine']=0;
    $totais['valorJuros']=0;
    $totais['balanceWPolicies']=0;
    $totais['discount']=0;
    for($x = 0; $x < count($invoices); $x++)
    {
      $this->cell($this->colsize[0], 6, $invoices[$x]->ref, 1, 0, 'C');
      $this->setFont(DEFAULT_REPORT_FONT, '', (strlen((string)$invoices[$x]->operation)/.5) <= ceil($this->colsize[1]) ? $this->fontSizeBody : ceil($this->colsize[1]/(strlen((string)$invoices[$x]->operation)/3.8)) );
      $this->cell($this->colsize[1], 6, substr($invoices[$x]->operation,0,35), 1, 0, 'L');
      $this->setFont(DEFAULT_REPORT_FONT, null, 8);
      $this->cell($this->colsize[2], 6, number_format($invoices[$x]->value,2,',','.'), 1, 0, 'C');
      $this->cell($this->colsize[3], 6, strlen((string)$invoices[$x]->payedValue) == 0  ?  '0,00' : number_format($invoices[$x]->payedValue,2,',','.'), 1, 0, 'C');
      $this->cell($this->colsize[4], 6, strlen((string)$invoices[$x]->fine) == 0 ? '0,00' : number_format($invoices[$x]->fine,2,',','.'), 1, 0, 'C');
      $this->cell($this->colsize[5], 6, strlen((string)$invoices[$x]->valorJuros) == 0 ? '0,00' : number_format($invoices[$x]->valorJuros,2,',','.'), 1, 0, 'C');
      $this->cell($this->colsize[6], 6, number_format($invoices[$x]->balanceWPolicies,2,',','.'), 1, 0, 'C');
      $this->cell($this->colsize[7], 6, strlen((string)$invoices[$x]->discount) == 0 ? '0,00' : number_format($invoices[$x]->discount,2,',','.'), 1, 0, 'C');
      $this->cell($this->colsize[8], 6, $invoices[$x]->maturityDate, 1, 0, 'C');
      $this->cell($this->colsize[9], 6, $invoices[$x]->entryDate, 1, 0, 'C');

      $totais['value']+=$invoices[$x]->value;
      $totais['payedValue']+=strlen((string)$invoices[$x]->payedValue) == 0  ?  0 : $invoices[$x]->payedValue;
      $totais['fine']+=strlen((string)$invoices[$x]->fine) == 0 ? 0 : $invoices[$x]->fine;
      $totais['valorJuros']+=strlen((string)$invoices[$x]->valorJuros) == 0 ? 0 : $invoices[$x]->valorJuros;
      $totais['balanceWPolicies']+=$invoices[$x]->balanceWPolicies;
      $totais['discount']+=strlen((string)$invoices[$x]->discount) == 0 ? 0 : $invoices[$x]->discount;

      $this->ln();
    }

    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
    $this->cell($this->colsize[0], 6, '-', 1, 0, 'C');
    $this->cell($this->colsize[1], 6, 'TOTAL', 1, 0, 'L');
    $this->cell($this->colsize[2], 6, number_format($totais['value'],2,',','.'), 1, 0, 'C');
    $this->cell($this->colsize[3], 6, number_format($totais['payedValue'],2,',','.'), 1, 0, 'C');
    $this->cell($this->colsize[4], 6, number_format($totais['fine'],2,',','.'), 1, 0, 'C');
    $this->cell($this->colsize[5], 6, number_format($totais['valorJuros'],2,',','.'), 1, 0, 'C');
    $this->cell($this->colsize[6], 6, number_format($totais['balanceWPolicies'],2,',','.'), 1, 0, 'C');
    $this->cell($this->colsize[7], 6, number_format($totais['discount'],2,',','.'), 1, 0, 'C');
    $this->cell($this->colsize[8], 6, '-', 1, 0, 'C');
    $this->cell($this->colsize[9], 6, '-', 1, 0, 'C');


    $this->ln();
/*
    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
    $this->cell(40, 8,_M('Payed value',$module).': ','','L',null);
    $this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
    $this->cell(10, 8,'R$ ','','','L');
    $this->cell(30, 8,SAGU::formatNumber($invoices[0]->totalReceived),'','','R');
    $this->ln();
    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
    $this->cell(40, 8,_M('Balance',$module).': ','','L',null);
    $this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
    $this->cell(10, 8,'R$ ','','','L');
    $this->cell(30, 8,SAGU::formatNumber($invoices[0]->totalToReceiv),'','','R');
    $this->ln();
    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
    $this->cell(40, 8,_M('Balance with policies',$module).': ','','','L');
    $this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
    $this->cell(10, 8,'R$ ','','','L');
    $this->cell(30, 8,SAGU::formatNumber($invoices[0]->adjustedValue),'','','R');
    $this->ln();
*/
    $this->ln();
    //$this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
    //MIOLO::vd($dataLP);
    $this->cell($this->psize,$this->lsize, strtoupper($this->pdfInfo->cityName . '/' . $this->pdfInfo->stateId . ', '. date('d/m/Y')) . '.', null, null, 'C');
    $this->ln();
    $this->ln();
    $this->MultiCell(190, 4, '_________________________________________________','','C');
    $this->MultiCell(190, 8, _M('Finance Director',$module),'','C');

    $this->output();
  }
}
?>
