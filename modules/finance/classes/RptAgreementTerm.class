<?php

/**
*
* This file handles the connection and actions for finBank table
*
* @author Giovani Murilo Dantas Correa [gmurilo@gmail.com]
*
* $version: $Id$
*
* \b Maintainers \n
* Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
* Daniel Afonso Heisler [daniel@solis.coop.br]
* Jamiel Spezia [jamiel@solis.coop.br]
* Rafael Luís Spengler [rafael@solis.coop.br]
* William Prigol Lopes [william@solis.coop.br]
* Eduardo Beal Miglioransa [eduardo@solis.coop.br]
*
* @since
* Class created on 18/10/2007
*
* \b Organization: \n
* iSolution - Soluções de Internet \n
* The iSolution TEAM
*
* \b CopyLeft: \n
* CopyLeft (L) 2007 iSolution - Soluções de Internet \n
*
* \b License \n
* Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html )
*
* \b History \n
* See history in CVS repository: http://isolution.inf.br   
*
**/

define('FPDF_FONTPATH', $MIOLO->getModulePath('basic', '/classes/fpdf/font/'));

$MIOLO = MIOLO::getInstance();
$module = 'finance';
$MIOLO->Uses('classes/fpdf/pdf.php', 'basic');

class RptAgreementTerm extends PDF
{

    public function __construct($filters)
    {
        $this->MIOLO  = MIOLO::getInstance();
        $this->title = _M('Agreement Term', 'finance');
        $this->db   = $this->MIOLO->getBusiness('finance', 'BusAgreementTerm');
        parent::__construct($filters);
        $this->aliasNbPages();
        $this->generatePDF();
	}
    
    public function generatePDF()
    {
        $this->addPage();
        $result = $this->db->getInvoices($this->filters);
       // MIOLO::vd($result);die();
        if (count($result) == 0 ) return;
        $obj = $result[0];
        foreach($result as $invoice)
        {
            if($invoice->invoiceType == 'I')
            {
                $obj->parValue += $invoice->valorGerado;
                $obj->parValueInc += ($invoice->valorGerado-$invoice->incentivo);
                $obj->juros += $invoice->jurosTitulo;
            }
        }
        $obj->juros    = SAGU::formatNumber((float)$obj->juros);
        $obj->parValue = SAGU::formatNumber($obj->parValue);
       
        $this->setFont(DEFAULT_REPORT_FONT, 'BI', $this->fontSizeBody);
        $this->SetFillColor(180,180,180);
        $this->cell($this->psize-50, $this->lsize, _M('Agreement id', 'finance'). ': ', 'LT', null,  'R', 1);
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell(50, $this->lsize,$obj->agreementId, 'TR', null, 'R', 1);
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);
        $this->cell(($this->psize)*0.07, $this->lsize, _M('Pupil', 'finance') .':', 'LT');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);
        $this->cell(($this->psize)*0.73,$this->lsize, $obj->personId . ' -  ' . $obj->personName,  'T');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);
        $this->cell(($this->psize)*0.07, $this->lsize, _M('CPF', 'basic') . ':', 'T', null, 'R');    
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.13, $this->lsize, SAGU::convertInCPFFormat($obj->cpf), 'TR', null, 'R');  
        $this->ln();
        /* Endereco */
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.10, $this->lsize, _M('Address', 'academic') .':', 'L');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.40,$this->lsize, $obj->location . ', ' . $obj->number, '');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.07, $this->lsize, _M('Neighborhood', 'basic') .':', '');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.28,$this->lsize, $obj->neighborhood, '');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.05,$this->lsize, _M('Zip code','basic') . ':', '', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.10,$this->lsize, $obj->zipcode, 'R', null, 'R');
        $this->ln();

        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.12, $this->lsize, _M('Complement', 'basic') .':', 'L');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.33,$this->lsize, $obj->complement, '');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.07, $this->lsize, _M('City', 'basic') .':', '');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.38,$this->lsize, $obj->city, '');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.05,$this->lsize, _M('State', 'basic') . ':', '', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.05,$this->lsize, $obj->state, 'R', null, 'R');
        $this->ln();
        //Telefone e email

        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.05, $this->lsize, _M('Email', 'basic') .':', 'L');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.41,$this->lsize, strtolower($obj->email), '');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.14, $this->lsize, _M('Residential phone', 'basic') .':');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.16,$this->lsize, $obj->phone, '', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.10,$this->lsize, _M('Cell phone', 'basic') . ':', '');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.14,$this->lsize, $obj->cellphone, 'R', null, 'R');
        $this->ln();

        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);
        $this->cell(($this->psize)*0.12, $this->lsize, _M('Responsable', 'finance') .':', 'L');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);
        $this->cell(($this->psize)*0.68,$this->lsize, $obj->responsableName,  '');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->defaultFontSize);
        $this->cell(($this->psize)*0.07, $this->lsize, _M('CPF', 'basic') . ':', '', null, 'R');    
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);         
        $this->cell(($this->psize)*0.13, $this->lsize, SAGU::convertInCPFFormat($obj->responsableCpf), 'R', null, 'R');  
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($this->psize*.13, $this->lsize, _M('Par value', 'finance'). ': ', 'L');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell($this->psize*.12, $this->lsize, 'R$ '. $obj->parValue, '', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($this->psize*.07, $this->lsize, _M('Interest', 'finance'). ': ', '');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell($this->psize*.12, $this->lsize, 'R$ '. $obj->juros, '', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($this->psize*.13, $this->lsize, _M('Valor negociado', 'finance'). ': ', '');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell($this->psize*.12, $this->lsize, 'R$ '. $obj->saldo, '', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($this->psize*.07, $this->lsize, _M('Down payment', 'finance'). ': ', '');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell($this->psize*.12, $this->lsize, 'R$ '. $obj->entrada, '', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($this->psize*.08, $this->lsize, _M('Parcels', 'finance'). ': ', '');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell($this->psize*.04, $this->lsize, $obj->parcelas, 'R', null, 'R');
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($this->psize*.26, $this->lsize, _M('Discount interest percent', 'finance'). ': ', 'BL', null);
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell($this->psize*.08, $this->lsize, SAGU::formatNumber((($obj->desconto)/( $obj->juros > 0 ? $obj->juros : 1 ) )*100). '%', 'B', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($this->psize*.07, $this->lsize, _M('Discount', 'finance'). ': ', 'B');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell($this->psize*.10, $this->lsize, 'R$ '. $obj->desconto, 'B', null, 'R');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($this->psize*.08, $this->lsize, _M('Date', 'finance'). ': ', 'B');
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell($this->psize*.10, $this->lsize, $obj->dateTime, 'B', '', 'R');
        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($this->psize*.07, $this->lsize, _M('User', 'admin'). ': ', 'B');        
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        $this->cell($this->psize*.24, $this->lsize, $obj->userName, 'BR', null, 'R');        
        $this->ln();
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, 'I', $this->fontSizeBody);
        $this->multicell($this->psize, $this->lsize, AGREEMENT_TEXT, 1, 'J'); 
        $this->ln();
        $this->line($this->x, $this->y, $this->psize+$this->lMargin, $this->y);
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, 'BI', $this->fontSizeBody);
        $this->cell($this->psize, $this->lsize, _M('Títulos negociados', 'finance'), 'B', null, 'C');
        $this->ln();
        unset($col);
        $col[0] = $this->psize*.08;
        $col[2] = $this->psize*.09;
        $col[3] = $this->psize*.10;
        $col[4] = $this->psize*.09;
        $col[5] = $this->psize*.09;
        $col[6] = $this->psize*.09;
        $col[7] = $this->psize*.09;
        $col[8] = $this->psize*.09;
        $col[10] = $this->psize-(array_sum($col));

        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($col[0], $this->lsize, _M('Invoice', 'finance'), 1, null, 'C');
        $this->cell($col[10], $this->lsize, _M('Income source', 'finance'), 1, null, 'C');
        $this->cell($col[2], $this->lsize, _M('Maturity', 'finance'), 1, null, 'C');
        $this->cell($col[4], $this->lsize, _M('Value', 'finance'), 1, null, 'C');
        $this->cell($col[3], $this->lsize, _M('Val. Neg.', 'finance'), 1, null, 'C');
        $this->cell($col[5], $this->lsize, _M('Updated', 'finance'), 1, null, 'C');
        $this->cell($col[6], $this->lsize, _M('Discount', 'finance'), 1, null, 'C');
        $this->cell($col[7], $this->lsize, _M('Incentive', 'finance'), 1, null, 'C');
        $this->cell($col[8], $this->lsize, _M('Interest', 'finance'), 1, null, 'C');
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        foreach ( $result as $invoice )
        {
            if($invoice->invoiceType == 'I')
            {
                $this->cell($col[0], $this->lsize, /*_M('Invoice', 'finance')*/ $invoice->invoiceId, 1, null, 'C');
                $this->cell($col[10], $this->lsize,/* _M('Income source', 'finance')*/ $invoice->origem, 1, null, 'C');
                $this->cell($col[2], $this->lsize, /*_M('Maturity', 'finance')*/$invoice->dataVencimento, 1, null, 'C');
                $this->cell($col[4], $this->lsize, /*_M('Value', 'finance')*/$invoice->valorGerado, 1, null, 'C');
                $this->cell($col[3], $this->lsize, /*_M('Down date', 'finance')*/ $invoice->aberto, 1, null, 'C');
                $this->cell($col[5], $this->lsize, /*_M('Updated', 'finance')*/ $invoice->pagamento, 1, null, 'C');
                $this->cell($col[6], $this->lsize,/* _M('Discount', 'finance')*/ $invoice->descontoTitulo, 1, null, 'C');
                $this->cell($col[7], $this->lsize, /*_M('Incentive', 'finance')*/$invoice->incentivo, 1, null, 'C');
                $this->cell($col[8], $this->lsize, /*_M('Interest', 'finance')*/$invoice->jurosTitulo, 1, null, 'C');                
                $this->ln();
            }
        }
        $this->setFont(DEFAULT_REPORT_FONT, 'BI', $this->fontSizeBody);
        $this->cell($this->psize, $this->lsize, _M('Títulos gerados', 'finance'), 'B', null, 'C');
        $this->ln();
        unset($col);
        $col[0] = $this->psize*.08;
        $col[2] = $this->psize*.09;
        $col[3] = $this->psize*.10;
        $col[4] = $this->psize*.10;
        $col[1] = $this->psize-(array_sum($col));

        $this->setFont(DEFAULT_REPORT_FONT, 'B', $this->fontSizeBody);
        $this->cell($col[0], $this->lsize, _M('Invoice', 'finance'), 1, null, 'C');
        $this->cell($col[1], $this->lsize, _M('Income source', 'finance'), 1, null, 'C');
        $this->cell($col[2], $this->lsize, _M('Maturity', 'finance'), 1, null, 'C');
        $this->cell($col[3], $this->lsize, _M('Value', 'finance'), 1, null, 'C');
        $this->cell($col[4], $this->lsize, _M('Parcel', 'finance'), 1, null, 'C');
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->fontSizeBody);
        foreach ( $result as $invoice )
        {
            if($invoice->invoiceType == 'O')
            {
                $this->cell($col[0], $this->lsize, /*_M('Invoice', 'finance')*/ $invoice->invoiceId, 1, null, 'C');
                $this->cell($col[1], $this->lsize,/* _M('Income source', 'finance')*/ $invoice->origem, 1, null, 'C');
                $this->cell($col[2], $this->lsize, /*_M('Maturity', 'finance')*/$invoice->dataVencimento, 1, null, 'C');
                $this->cell($col[3], $this->lsize, /*_M('Value', 'finance')*/$invoice->valorGerado, 1, null, 'C');
                $this->cell($col[4], $this->lsize, /*_M('Value', 'finance')*/$invoice->parcelNumber, 1, null, 'C');
                $this->ln();
            }
        }
        $this->ln();
        $this->cell($this->psize,$this->lsize, strtoupper($this->pdfInfo->cityName . '/' . $this->pdfInfo->stateId . ', '.$obj->dateTime), null, null, 'C');
        
        $this->ln();
        $this->ln();
        $this->ln();
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);
        $this->cell(($this->psize/6)*2, $this->lsize, '', null, null, 'C');
        $this->cell($this->psize/3, $this->lsize, '', 'B', null, 'C');
        $this->ln();
        $this->setFont(DEFAULT_REPORT_FONT, 'BI', $this->defaultFontSize);
        $this->cell($this->psize, $this->lsize, _M('Compromitente', 'academic'), null, null, 'C');
        $this->ln();
        $this->ln();
        $this->ln();
        $this->ln();
         $this->setFont(DEFAULT_REPORT_FONT, '', $this->defaultFontSize);
        $this->cell(($this->psize/6)*2, $this->lsize, '', null, null, 'C');
        $this->cell($this->psize/3, $this->lsize, '', 'B', null, 'C');
        $this->ln();
       $this->setFont(DEFAULT_REPORT_FONT, 'BI', $this->defaultFontSize);
        $this->cell($this->psize, $this->lsize, _M('Compromissário', 'academic'), null, null, 'C');
        parent::generatePDF();
    }
}
?>
