<?php

/**
 * Class to generate the bank remittance
 * FEBRABAN
 */
class ReturnInvoice104
{
	public $header;
	public $treiler;
	public $detail;
	public $processInfo;
	public function ReturnInvoice104($data)
	{
		$file = SAGUFile::GetFilePath($data->fileId);
		$MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
		$businessReturn = $MIOLO->getBusiness($module, 'BusReturnInvoice');
		if(file_exists($file))
		{
			$fread = file($file);
			$size = strlen((string)str_replace("\n",'',$fread[0]))-1;
			$businessReturn->fileId = $data->fileId;
			//CNAB 240
			if($size == 240) 
			{
				if(substr($fread[0],7,1) == 0)
				{
					$this->header->bankId		= substr($fread[0],0,3);
					$this->header->serviceLot	= substr($fread[0],3,4);
					$this->header->fileHeader	= substr($fread[0],7,17);
					$this->header->cjpn			= substr($fread[0],18,14);
					$this->header->accord		= substr($fread[0],58,6);
					$this->header->branch		= substr($fread[0],52,5);
					$this->header->branchDigit	= substr($fread[0],57,1);
					$this->header->account		= substr($fread[0],58,12);
					$this->header->accountDigit	= substr($fread[0],71,1);
					$this->header->type			= substr($fread[0],142,1);
					$this->header->genDate		= substr($fread[0],143,8);
					$this->header->genTime		= substr($fread[0],151,6);
					$this->header->occurrence	= substr($fread[0],230,10);	
				}
				if(substr($fread[count($fread)-1],7,1) == 9)
				{
					$this->treiler->bankId		= substr($fread[count($fread)-1],0,3);
					$this->treiler->serviceLot	= substr($fread[count($fread)-1],3,4);
					$this->treiler->totalLot	= substr($fread[count($fread)-1],17,6);
					$this->treiler->totalRegist	= substr($fread[count($fread)-1],23,6);
				}
			}
			$businessReturn->openTransaction();
			for($x = 1; $x < (count($fread)-1); $x++)
			{
				unset($this->detail);
				if($size == 240) 
				{
					if( substr($fread[$x],7,1) == 3 && substr($fread[$x],13,1) == 'T' )
					{
						$this->detail->bankInvoiceId	= (int)trim(substr($fread[$x],42,14));
						$this->detail->documentNumber	= substr($fread[$x],58,11);
						$this->detail->maturityDate		= substr($fread[$x],73,8);
						$this->detail->value			= (float)(substr($fread[$x],81,15)/100);
                        MIOLO::vd($this->detail);
						$this->detail->myBankInvoiceId  = substr($fread[$x],105,25);
						$this->detail->inscription		= substr($fread[$x],133,15);
						$this->detail->name				= substr($fread[$x],148,40);
						$this->detail->tax				= (float)(substr($fread[$x],198,15)/100);
						$this->detail->cnab			    = substr($fread[$x],223,17);
						if ( substr($fread[$x+1],13,1) == 'U' && substr($fread[$x+1],7,1) == 3 )
						{
							$this->detail->charges			= (float)(substr($fread[$x+1],17,15)/100);
							$this->detail->discount			= (float)(substr($fread[$x+1],32,15)/100);
							$this->detail->payedValue		= (float)(substr($fread[$x+1],77,15)/100);
							$this->detail->entryDate		= substr($fread[$x+1],137,8);
							$this->detail->ourNumber		= substr($fread[$x+1],213,20);
						}
						$dataX = $this->detail;
						$dataX->bankAccountId = $data->bankAccountId;
						$dataX->accord = (float)trim($this->header->accord);
						$dataX->bankInvoiceIdX = $this->detail->bankInvoiceId;
						if( $dataX->accord == substr($this->detail->bankInvoiceId,0,strlen((string)$dataX->accord)) )
						{
							$dataX->bankInvoiceId  = (float)substr($this->detail->bankInvoiceId,strlen((string)$dataX->accord), strlen((string)$this->detail->bankInvoiceId)-strlen((string)$dataX->accord)-1);
						}
						else if ( stristr( $this->detail->bankInvoiceId, str_pad((float)$this->header->branch,4,0,STR_PAD_LEFT).str_pad((float)$this->header->account,8,0,STR_PAD_LEFT) ) == TRUE )
						{
							$pos = strpos( $this->detail->bankInvoiceId,  str_pad((float)$this->header->branch,4,0,STR_PAD_LEFT).str_pad((float)$this->header->account,8,0,STR_PAD_LEFT) );
							$dataX->bankInvoiceId = (float)substr($this->detail->bankInvoiceId,0,$pos);
						}
						$businessReturn->processDetail($dataX);
					}
				}
			}
			$businessReturn->closeTransaction();
			$this->processInfo = $businessReturn->processInfo;
		}
	}
}
?>
