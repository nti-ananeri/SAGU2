<?php

/**
 *
 * This file handles the connection and actions for finBank table
 *
 * @author Giovani Murilo Dantas Correa [gmurilo@gmail.com]
 *
 * $version: $Id$
 *
 * \b Maintainers \n
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Daniel Afonso Heisler [daniel@solis.coop.br]
 * Jamiel Spezia [jamiel@solis.coop.br]
 * Rafael Luís Spengler [rafael@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 * Eduardo Beal Miglioransa [eduardo@solis.coop.br]
 *
 * @since
 * Class created on 18/10/2007
 *
 * \b Organization: \n
 * iSolution - Soluções de Internet \n
 * The iSolution TEAM
 *
 * \b CopyLeft: \n
 * CopyLeft (L) 2007 iSolution - Soluções de Internet \n
 *
 * \b License \n
 * Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html )
 *
 * \b History \n
 * See history in CVS repository: http://isolution.inf.br
 *
 **/

set_time_limit(0);
$MIOLO = MIOLO::getInstance();
$module = 'finance';

define('FPDF_FONTPATH', $MIOLO->getModulePath('basic', '/classes/fpdf/font/'));
$MIOLO->Uses('classes/fpdf/pdf.php', 'basic');

/**
 * Create header and footer information
 */

class RptCounterMovement extends PDF
{

  var $module = 'finance';
  var $MIOLO;

  public function __construct($filters = NULL)
  {
    $this->MIOLO  = MIOLO::getInstance();
    foreach($filters as $item => $value )
    {
      if(!$this->headerData->{$item} )
      {
        $this->headerData->{$item} = $value;
      }
    }
    $this->title = strtoupper(_M('Relatório de Movimentação de Caixa', 'finance'));
    parent::__construct();
    $this->useUserInfo = true;
    $this->addPage($filters->reportType == 2 ? 'L' : 'P', 'mm', 'A4');
    $this->aliasNbPages();
    $this->generatePDF($filters);
  }

  public function generatePDF($data)
  {
    $module = 'finance';
    $this->ln();
    $this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
    $this->cell(30, 5, _M('Operator', $module). ':', 1, 0, 'L');
    $this->setFont(DEFAULT_REPORT_FONT, null, 8);
    $this->cell(163, 5,'          '.$data[0][3], 1, 0, 'L');
    $this->ln();
    $this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
    $this->cell(55, 6, _M('Student', 'basic'), 1, 0, 'C');
    $this->cell(20, 6, _M('Value', $module), 1, 0, 'C');
    $this->cell(25, 6, _M('Date', $module), 1, 0, 'C');
    $this->cell(18, 6, _M('Specie', $module), 1, 0, 'C');
    $this->setFont(DEFAULT_REPORT_FONT, 'B', 7);
    $this->cell(25, 6, _M('Vencimento', $module), 1, 0, 'C');
    $this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
    $this->cell(15, 6, _M('Discount', $module), 1, 0, 'C');
    $this->cell(15, 6, _M('Interest', $module), 1, 0, 'C');
    $this->cell(20, 6, _M('Value', $module), 1, 0, 'C');
    $this->ln();
    $this->setFont(DEFAULT_REPORT_FONT, null, 6);
    $total = 0;
    $totaisespecies = array();
    for($x = 0; $x < count($data); $x++)
    {
      $this->cell(55, 4, $data[$x][9],1, 0, 'L');
      $this->cell(20, 4, $data[$x][4],1, 0, 'C');
      $this->cell(25, 4, $data[$x][5],1, 0, 'C');
      $this->cell(18, 4, $data[$x][8],1, 0, 'C');
      $totaisespecies[$data[$x][8]]+=(float)$data[$x][4];
      $this->cell(25, 4, $data[$x][10],1, 0, 'C');
      $this->cell(15, 4, $data[$x][11],1, 0, 'C');
      $this->cell(15, 4, $data[$x][12],1, 0, 'C');
      $this->cell(20, 4, $data[$x][13],1, 0, 'C');
      $total += (float)$data[$x][4];
      $this->ln();
    }
    $this->ln();
    $this->setFont(DEFAULT_REPORT_FONT, 'BI', 8);
    foreach ($totaisespecies as $especies=>$valor)
    {
      $this->cell(40, 6,$especies.': ','','L',null);
      $this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
      $this->cell(10, 6,'R$ ','','','L');
      $this->cell(30, 6,number_format($valor,2,',','.'),'','','R');
      $this->ln();
    }
    $this->cell(40, 8,_M('Total',$module).': ','','L',null);
    $this->setFont(DEFAULT_REPORT_FONT, 'B', 8);
    $this->cell(10, 8,'R$ ','','','L');
    $this->cell(30, 8,number_format($total,2,',','.'),'','','R');
    $this->ln();
    $this->ln();
    
    
    $bCompany = $this->MIOLO->getBusiness('basic','BusCompany');
    $dataC   = $bCompany->getCompany(DEFAULT_COMPANY_CONF);
    $bLPerson = $this->MIOLO->getBusiness('basic','BusLegalPerson');
    $dataLP	 = $bLPerson->getLegalPerson($dataC->personId);
    
    $this->cell(190, 8, $dataLP->cityName . ', ' . date('d/m/Y') . '.', '', '', 'C');
    $this->ln();
    $this->ln();

    $this->output();
  }
}
?>
