<?php

/**
 *
 * This file handles the connection and actions for fiReceivableInvoice table
 *
 * @author Armando Taffarel Neto [taffarel@solis.coop.br]
 *
 * $version: $Id$
 *
 * \b Maintainers \n
 * Armando Taffarel Neto [taffarel@solis.coop.br]
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Daniel Afonso Heisler [daniel@solis.coop.br]
 * Eduardo Beal Miglioransa [eduardo@solis.coop.br]
 * Jamiel Spezia [jamiel@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 * 
 * @since
 * Class created on 13/12/2005
 *
 * \b @organization \n
 * SOLIS - Cooperativa de Soluções Livres \n
 * The Sagu2 development team
 *
 * \b Copyleft \n
 * Copyleft (L) 2005 - SOLIS - Cooperativa de Soluções Livres \n
 *
 * \b License \n
 * Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html )
 *
 * \b History \n
 * See history in CVS repository: http://sagu.solis.coop.br   
 *
 **/
 
$MIOLO  = MIOLO::getInstance();
$MIOLO->uses('forms/FrmInvoice.class', 'finance');
/**
 * Form to search the finInvoice table
 */
class FrmReceivableInvoice extends FrmInvoice
{

    /**
     * Class constructor
     */
    function __construct()
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $function = MIOLO::_request('function');
        $this->module = $module;
        $goto = MIOLO::_request('goto') ? MIOLO::_request('goto') : MIOLO::_request('goto', 'GET');

        if ( $function == 'update' )
        {
            parent::__construct(_M('Update', $module));
        }
        else
        {
            parent::__construct(_M('Insert', $module));
        }
        
        $field = new MHiddenField('goto', $goto);
        $this->addField($field);
        // hide the 'Submit' button
        $this->setShowPostButton(false);

        $this->setHelp(get_class($this), MIOLO::getCurrentModule(), MIOLO::getCurrentAction());
        $this->eventHandler();
    }

    /**
     *  Default method to define fields
     */
    public function createFields()
    {
        $MIOLO  = MIOLO::getInstance();
        $module = $this->module;
        $function = MIOLO::_request('function');
        if ( in_array($function, array('update', 'delete')) )
        {
            $invoiceId = strlen((string)MIOLO::_request('invoiceId', 'GET'))>0 ? MIOLO::_request('invoiceId', 'GET') : MIOLO::_request('invoiceId');
            $business = $MIOLO->getBusiness($module, 'BusReceivableInvoice');

            $data     = $business->getReceivableInvoice($invoiceId);
        }

        $this->createInvoiceFields($data);
        
        $fields[] = new MHiddenField('goto', MIOLO::_request('goto') ? MIOLO::_request('goto') : $this->getFormValue('goto', $goto));
        
        if ($function == 'update')
        {
            $fields[] = new MTextLabel('lastModification', '['.$data->userName.' - '.$data->dateTime.']', _M('Last modification', $module));
        }
        
        $fields[] = new Separator('');
        $this->addFields($fields);
        $this->setLabelWidth(FIELD_LABEL_SIZE);
        $this->setShowPostButton(false);
        $this->setClose($MIOLO->getActionURL($module, substr($action, 0, strrpos($action, ':'))));
    }
   

    /**
     * Event triggered when user chooses New from the toolbar
     **/
    public function tbBtnNew_click($sender = null)
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $action = MIOLO::getCurrentAction();

        $data = $this->getTypesData();
        $vars = get_object_vars($data);
    }
    
    /**
     * Event triggered when user chooses Delete from the toolbar
     **/
    public function tbBtnDelete_click($sender = null)
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $action = MIOLO::getCurrentAction();
        $invoiceId = MIOLO::_request('invoiceId') ? MIOLO::_request('invoiceId') : MIOLO::_request('invoiceId', 'GET');
        $goto   = MIOLO::_request('goto') ? MIOLO::_request('goto') : MIOLO::_request('goto', 'GET');
        
        $data   = $this->getTypesData();
        $opts   = array('event'     => 'tbBtnDelete_confirm',
                        'function'  => 'delete',
                        'invoiceId' => $invoiceId,
                        'goto'      => urlencode(strlen((string)$goto)>0 ? $goto : SAGU::getStackBackUrl())
                       );
            

        $gotoYes = $MIOLO->getActionURL( $module, $action, null, $opts );
        $gotoNo = $goto;
        
        if (!strlen((string)$gotoNo)>0)
        {
            $goto    = SAGU::getStackBackUrl();
            $gotoNo  = strlen((string)$goto)>0 ? $goto : $MIOLO->getActionURL($module, $action);
        }
        $business = $MIOLO->getBusiness($module, 'BusReceivableInvoice');
        $return = $business->getReceivableInvoice($invoiceId);
        if( strlen((string)$return->bankInvoiceId) > 0 )
        {
            $msg    = _M('This title already has bank invoice generated, it will be charged back. @1 Would you like to proceed ?',$module,'<br>');
        }
        else
        {
            $msg     = MSG_CONFIRM_RECORD_DELETE;
        }
        $caption = _M('Question', $module);
        $MIOLO->question($msg, $gotoYes, $gotoNo);
    }
    
    /**
     * Event triggered when user chooses Yes from the Delete prompt dialog
     **/
    public function tbBtnDelete_confirm($sender = null)
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $action = MIOLO::getCurrentAction();

        $business = $MIOLO->getBusiness($module, 'BusReceivableInvoice');
        $ok = $business->deleteReceivableInvoice(MIOLO::_request('invoiceId'));

        if ( $ok )
        {
            $msg  = MSG_RECORD_DELETED;
            $goto = $this->getFormValue('goto', MIOLO::_request('goto') ? MIOLO::_request('goto') : MIOLO::_request('goto', 'GET'));
            $opts = array ( 'personId' => MIOLO::_request('personId'), 'event' => 'btnSearch_click' );
            if (!strlen((string)$goto)>0)
            {
                $goto = SAGU::getStackBackUrl();
            }
            $goto = strlen((string)$goto)>0 ? $MIOLO->getActionURL($module, 'main', null, $opts ) : $MIOLO->getActionURL($module, $action, null, $opts);
            $caption = _M('Information',$module);
            $MIOLO->information($msg, $goto);
        }
        else
        {
            $msg  = _M('Error executing requested operation.',$module);
            $goto = MIOLO::_request('goto', 'GET');
            if (!strlen((string)$goto)>0)
            {
                $goto = SAGU::getStackBackUrl();
            }
            $goto = strlen((string)$goto)>0 ? $goto : $MIOLO->getActionURL($module, $action);
            $caption = _M('Error', $module);
            $MIOLO->error( $msg, $goto, $caption );
        }
    }
   
    /**
     * Event triggered when user chooses Save from the toolbar
     **/
    public function tbBtnSave_click($sender = null)
    {
        $MIOLO    = MIOLO::getInstance();
        $module   = MIOLO::getCurrentModule();
        $action   = MIOLO::getCurrentAction();
        $function = MIOLO::_request('function');

        $data     = $this->getTypesData();
        $business = $MIOLO->getBusiness($module, 'BusReceivableInvoice');

        if ( $function == 'update' )
        {
            $ok  = $business->updateReceivableInvoice($data);
            $msg = MSG_RECORD_UPDATED;
        }
        else
        {
            $ok  = $business->insertReceivableInvoice($data);
            $data->invoiceId = $ok;
            if( strlen((string)$ok) > 0 )
            {
                $business = $MIOLO->getBusiness($module, 'BusEntry');
                $data->comments = $data->entryComments;
                $ok       = $business->insertEntry($data);
         
            }
            $msg = MSG_RECORD_INSERTED;
        }

        if ( $ok )
        {
            $opts = array('invoiceIdS'=>$data->invoiceId);
            $goto = $this->getFormValue('goto');
            if (!(strlen((string)$goto)>0))
            {
                $goto = SAGU::getStackBackUrl();
            }
            $goto = strlen((string)$goto)>0 ? $goto : $MIOLO->getActionURL( $module, $action, null, $opts);

            if ( $function == 'update' )
            {
                $caption = _M('Information', $module);
                $MIOLO->information($msg, $goto);
            }
            else
            {

                $optsYes = array('event'   =>'tbBtnNew_click',
                                 'function'=>'insert');

                $gotoYes = $MIOLO->getActionURL($module, $action, null, $optsYes);
                
                $optsNo  = array('event'     =>'tbBtnSearch_click',
                                 'function'  =>'search',
                                 'invoiceIdS'=>$data->invoiceId);

                $gotoNo   = SAGU::getStackBackUrl();
                $gotoNo   = strlen((string)$gotoNo)>0 ? $gotoNo : $MIOLO->getActionURL($module, $action, null, $optsNo);

                $MIOLO->question($msg, $gotoYes, $gotoNo);
            }
        }
        else
        {
            $msg  = _M('Error executing requested operation.', $module);
            
            $goto = $this->getFormValue('goto');
            if (!(strlen((string)$goto)>0))
            {
                $goto = SAGU::getStackBackUrl();
            }
            $goto = strlen((string)$goto)>0 ? $goto : $MIOLO->getActionURL($module, $action);
            
            $caption = _M('Error', $module);
            $MIOLO->error($msg, $goto, $caption);
        }
    }
    
    
    public function getTypesData()
    {
        $data = new FinReceivableInvoice();
        $vars = get_object_vars($data);
        foreach ( $vars as $var => $value )
        {
            if ( $this->$var && $var != 'description' )
            {
                $data->$var = $this->$var->value;
            }
        }
        $data->operationId    = $this->operationId->value;
        $data->entryDate      = $this->entryDate1->value;
        $data->entryComments  = $this->entryComments->value;
        $data->bankReturnCode = $this->bankReturnCode->value;
        $data->creationType   = MANUAL_ENTRY_CREATION_TYPE;
        return $data;
    }
}
?>
