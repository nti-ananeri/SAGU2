<?php
/**
 *
 * This file handles the connection and actions for finInvoice table
 *
 * @author William Prigol Lopes [taffarel@solis.coop.br]
 *
 * $version: $Id$
 *
 * \b Maintainers \n
 * Armando Taffarel Neto [taffarel@solis.coop.br]
 * Eduardo Beal Miglioransa [eduardo@solis.coop.br]
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Daniel Afonso Heisler [daniel@solis.coop.br]
 * Jamiel Spezia [jamiel@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 * 
 * @since
 * Class created on 13/12/2005
 *
 * \b @organization \n
 * SOLIS - Cooperativa de Soluções Livres \n
 * The Sagu2 development team
 *
 * \b Copyleft \n
 * Copyleft (L) 2005 - SOLIS - Cooperativa de Soluções Livres \n
 *
 * \b License \n
 * Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html )
 *
 * \b History \n
 * See history in CVS repository: http://sagu.solis.coop.br   
 *
 **/

/** Botão voltar deve retornar à consulta atual
 * Form to search the finInvoice table
 */
class FrmInvoiceConsult extends MForm
{
    public  $module;
    public  $filters;
    public  $data;

    /**
     *  Default method to define fields
     */
    public function createInvoiceFields($data)
    {
        $MIOLO    = MIOLO::getInstance();
        $module   = MIOLO::getCurrentModule();
        $action   = MIOLO::getCurrentAction();
        $function = MIOLO::_request('function');
        $MIOLO->getClass($module, 'finance');        
        $this->setTitle(null);
        
        $businessInvoice = $MIOLO->getBusiness($module, 'BusInvoice');
        $invoiceId = MIOLO::_request('invoiceId') ? MIOLO::_request('invoiceId') : MIOLO::_request('invoiceId', 'GET');

        if (!$invoiceId)
        {
            $bankAccountContractId = MIOLO::_request('bankAccountContractId') ? MIOLO::_request('bankAccountContractId') : MIOLO::_request('bankAccountContractId', 'GET');
            list ($bankAccountId, $bankContractId) = explode ('-', $bankAccountContractId);

            //$invoiceId = $businessInvoice->getInvoiceIdByBankInvoiceId(MIOLO::_request('returnBankCode') ? MIOLO::_request('returnBankCode') : MIOLO::_request('returnBankCode', 'GET'));
            $invoiceId = $businessInvoice->getInvoiceIdByBankInvoiceAndBankContractAndBanAccount(MIOLO::_request('returnBankCode') ? MIOLO::_request('returnBankCode') : MIOLO::_request('returnBankCode', 'GET'), $bankContractId, $bankAccountId);
        }
        $data->invoiceId = $invoiceId;
       
        $goto    = MIOLO::_request('goto') ? MIOLO::_request('goto') : MIOLO::_request('goto', 'GET');

        //
        // Show the entries for this titles
        //
        // BEGIN GRID
        $grdReceivableInvoice = $MIOLO->getUI()->getGrid($module, 'GrdReceivableInvoiceConsult', $data);
        $grdReceivableInvoice->setTitle(_M('Entries for invoice @1', $module, $invoiceId));
        $businessEntry        = $MIOLO->getBusiness($module, 'BusEntry');
        $entryData            = $businessEntry->listEntryData($data->invoiceId, 4);
        $grdReceivableInvoice->setData($entryData);
        $footer1              = new MText('footer', str_repeat('&nbsp;', '5') . _M('Open balance', $module) .':', 'blue');
        $footer1->setWidth('600');
        $openBalance          = $businessInvoice->getInvoiceBalance($data->invoiceId);
        $footer2              = new MText('footer2', $openBalance, $openBalance>0 ? 'red' : 'blue');
        $footerA1             = array($footer1, $footer2);
        $hctFooter1           = new MHContainer('hctFooter', $footerA1);

        $footer3        = new MText('footer3', str_repeat('&nbsp;', '5') . _M('Updated balance', $module).':', 'blue');
        $footer3->setWidth('600');
        $updatedBalance = $businessInvoice->getInvoiceBalanceWithPolicies($data->invoiceId);
        $footer4        = new MText('footer4', $updatedBalance, $updatedBalance>0 ? 'red' : 'blue');
        $footerA2       = array($footer3, $footer4);
        $hctFooter2     = new MHContainer('hctFooter2', $footerA2);
        $vctFooter      = new MVContainer('vctFooter', array($hctFooter1, $hctFooter2)); 
        $grdReceivableInvoice->setFooter($vctFooter);
        $fields[] = $grdReceivableInvoice;
        // END GRID
        
        $isAccounted = $businessInvoice->verifyAccountedEntriesForInvoice($invoiceId);

        // Information to return to that page
        $_opts = array('invoiceId'=>$invoiceId,
                       'event'=>'btnSearch_click'
                      );        
        $goto = $MIOLO->getActionURL($module, 'main', null, $_opts);
        
        // First button - INSERT ENTRY
        if( is_array($entryData) )
        {
            if ( !$entryData[0][9] == 'C' )
            {
                $opts = array('invoiceId'=>$invoiceId, 
                      'event'=>'tbBtnNew:click',
                      'function'=>'insert',
                      'costCenterId'=>$data->costCenterId,
                      'goto'=>urlencode($goto)
                     );
                $buttons[] = new MLink('insertEntry', _M('Insert entry', $module), $MIOLO->getActionURL($module, 'main:register:entry', null, $opts));                
                $buttons[] = new MLabel(' - '); 
            }
        }
        else
        {
            $opts = array('invoiceId'=>$invoiceId, 
                      'event'=>'tbBtnNew:click',
                      'function'=>'insert',
                      'costCenterId'=>$data->costCenterId,
                      'goto'=>urlencode($goto)
                     );
            $buttons[] = new MLink('insertEntry', _M('Insert entry', $module), $MIOLO->getActionURL($module, 'main:register:entry', null, $opts));                
            $buttons[] = new MLabel(' - '); 
        }
        // BEGIN BUTTONS
        if (MIOLO::_request('updated', 'GET') == true)
        {
            $fields[] = new MText('updateNominalValue', _M('Nominal value updated', $module));
        }
        else
        {
            $opts = array('invoiceId'=>$invoiceId, 'returnBankCode'=>$this->getFormValue('returnBankCode', $data->returnBankCode) ? $this->getFormValue('returnBankCode', $data->returnBankCode) : MIOLO::_request('returnBankCode', 'GET'), 'event'=>'updateNominalValue_click');
            $buttons[] = new MLink('updateNominalValue', _M('Update nominal value', $module), $MIOLO->getActionURL($module, "main:report:receivableInvoiceConsult", null, $opts));
            $buttons[] = new MLabel(' - ');
        }

        if ($isAccounted == false)
        {
            $opts = array("invoiceId"=>$invoiceId, 'goto'=>urlencode($goto));
            $closeInvoiceURL = $MIOLO->getActionURL($module, "main:process:closeInvoice", null, $opts);

            $buttons[] = new MLink('closeInvoice', _M('Close invoice', $module), $closeInvoiceURL);
            $buttons[] = new MLabel(' - ');        
        }

        $opts = array('invoiceId'=>$invoiceId, 
                      'function'=>'update',
                      'goto'=>str_replace("&amp;", "%26", urlencode($goto)));

        $buttons[] = new MLink('ChangeReceivableInvoice', _M('Change invoice', $module), $MIOLO->getActionURL($module, "main:register:invoice:receivableInvoice", null, $opts));
        $buttons[] = new MLabel(' - ');
        $buttons[] = new MLink('newConsultation', _M('New consultation', $module), $MIOLO->getActionURL($module, "main"));

        $buttons[] = new MLabel(' - ');
        $buttons[] = new MLink('Back', _M('Back', $module), $MIOLO->getActionURL($module, 'main', null, array('personId'=>$data->personId, 'event'=>'btnSearch_click')));
        $divButtons = new MDiv('divButtons', $buttons, null, 'align="center"');
        
        $fields[]   = $divButtons;
        $fields[]   = new MSeparator('');
        // END BUTTONS -------

        // BEGIN BASE LABEL -------
        $field2[] = new MHiddenField('invoiceId', $this->getFormValue('invoiceId', $data->invoiceId));
        
        // Invoice
        $invoiceIdLabel = new MText('invoiceIdLabel', _M('Invoice id', $module).':');
        $invoiceIdLabel->setWidth(FIELD_CONTAINER_SIZE);
        $invoiceId      = new MTextLabel('invoiceId', $data->invoiceId ? $data->invoiceId : $this->getFormValue('invoiceId', $data->invoiceId));
        $field2[]       = new MHContainer('hctInvoiceId', array($invoiceIdLabel, $invoiceId));
        
        // Bank invoice id
        $bankInvoiceIdLabel = new MText('bankInvoiceIdLabel', _M('Bank invoice id', $module).':');
        $bankInvoiceIdLabel->setWidth(FIELD_CONTAINER_SIZE);
        $bankInvoiceId      = new MText('bankInvoiceId_', $this->getFormValue('bankInvoiceId', $data->bankInvoiceId));
        $hctBankInvoice     = new MHContainer('hctBankInvoice', array($bankInvoiceIdLabel, $bankInvoiceId));
        $field2[]           = $hctBankInvoice;
        
        $personData = $businessInvoice->getPersonDataForInvoice($data->invoiceId ? $data->invoiceId : $this->getFormValue('invoiceId', $data->invoiceId));
        // Person
        $personLabel = new MText('personLabel', _M('Person', $module).':');
        $personLabel->setWidth(FIELD_CONTAINER_SIZE);
        $personId    = new MText('personId_', $personData->personId ? $personData->personId : $this->getFormValue('personId', $personData->personId));
        $personTrace = new MText('personTrace', '-');
        $personName  = new MText('personName_', $personData->personName ? $personData->personName : $this->getFormValue('personName', $personData->personName));
        $hctPerson   = new MHContainer('hctPerson', array($personLabel, $personId, $personTrace, $personName));
        $field2[]    = $hctPerson;
        
        // AccountScheme
        $accountSchemeLabel       = new MText('accountSchemeLabel', _M('Account scheme', $module).':');
        $accountSchemeLabel->setWidth(FIELD_CONTAINER_SIZE);
        $accountSchemeId          = new MText('accountSchemeId_', FINANCE::formatAccountSchemeId($this->getFormValue('accountSchemeId', $data->accountSchemeId)));
        $businessAccountScheme    = $MIOLO->getBusiness('accountancy', 'BusAccountScheme');
        $accountSchemeData        = $businessAccountScheme->getAccountScheme($this->getFormValue('accountSchemeId', $data->accountSchemeId));
        $accountSchemeTrace       = new MText('accountSchemeTrace', '-');
        $accountSchemeDescription = new MText('accountSchemeDescription_', $accountSchemeData->description);
        $hctAccountScheme         = new MHContainer('hctAccountScheme', array($accountSchemeLabel, $accountSchemeId, $accountSchemeTrace, $accountSchemeDescription));
        $field2[]                 = $hctAccountScheme;
       
        // CostCenter
        $costCenterLabel       = new MText('costCenterLabel', _M('Cost center', $module).':');
        $costCenterLabel->setWidth(FIELD_CONTAINER_SIZE);
        $costCenterId          = new MText('costCenterId_', FINANCE::formatCostCenterId($this->getFormValue('costCenterId', $data->costCenterId)));
        $costCenterTrace       = new MText('costCenterTrace', '-');
        $businessCostCenter    = $MIOLO->getBusiness('accountancy', 'BusCostCenter');
        $costCenterData        = $businessCostCenter->getCostCenter($this->getFormValue('costCenterId', $data->costCenterId));
        $costCenterDescription = new MText('costCenterDescription_', $costCenterData->description);
        $hctCostCenter         = new MHContainer('hctCostCenter', array($costCenterLabel, $costCenterId, $costCenterTrace, $costCenterDescription));
        $field2[]              = $hctCostCenter;
       
        // Course
        $courseLabel           = new MText('courseLabel', _M('Course', $module).':');
        $courseLabel->setWidth(FIELD_CONTAINER_SIZE);
        if (strlen((string)$data->courseId)>0)
        {
            $businessCourse          = $MIOLO->getBusiness('academic', 'BusCourse');
            $courseData              = $businessCourse->getCourse($this->getFormValue('courseId', $data->courseId), $this->getFormValue('courseVersion', $data->courseVersion));

            // Course
	        $courseId                = new MText('courseId_', $this->getFormValue('courseId', $data->courseId));
            $courseName              = new MText('courseName_', $courseData->shortName);
        	$courseTrace             = new MText('courseTrace', '-');

            // Course Version
    	    $courseVersion           = new MText('courseVersion_', $this->getFormValue('courseVersion',$data->courseVersion));
	        $couseVersionDescription = new MText('couseVersionDescription_', _M('Version', $module).':');
            $hctCourse               = new MHContainer('hctCourse', array($courseLabel, $courseId, $courseTrace, $courseName, $couseVersionDescription, $courseVersion));

        }
        else
        { 
            $courseData->shortName = _M('No course related', $module);
            $courseName = new MText('courseName_', $courseData->shortName);
            $hctCourse = new MHContainer('hctCourse', array($courseLabel, $courseName));
        }
       
        $field2[] = $hctCourse;        
       
        // Unit
        $unitLabel = new MText('unitLabel', _M('Unit', $module).':');
        $unitLabel->setWidth(FIELD_CONTAINER_SIZE);
        if (strlen((string)$data->unitId)>0)
        {
            $unitId          = new MText('unitId_', $this->getFormValue('unitId', $data->unitId));
            $unitTrace       = new MText('unitTrace', '-');
            $businessUnit    = $MIOLO->getBusiness('basic', 'BusUnit');
            $dataUnit        = $businessUnit->getUnit($this->getFormValue('unitId', $data->unitId));
            $unitDescription = new MText('unitDescription_', $dataUnit->description);
            $hctUnit         = new MHContainer('hctUnit', array($unitLabel, $unitId, $unitTrace, $unitDescription));
            $hctUnit->setShowLabel(true);
        }
        else
        {
            $dataUnit->description = _M('No unit related', $module);
            $unitDescription       = new MText('unitDescription_', $dataUnit->description);
            $hctUnit               = new MHContainer('hctUnit', array($unitLabel, $unitDescription));
        }
        $field2[]        = $hctUnit;
 
        // ParcelNumber
        $parcelNumberLabel = new MText('parcelNumberLabel', _M('Parcel number', $module).':');
        $parcelNumberLabel->setWidth(FIELD_CONTAINER_SIZE);
        $parcelNumber      = new MText('parcelNumber_', $this->getFormValue('parcelNumber', $data->parcelNumber));
        $hctParcelNumber   = new MHContainer('hctParcelNumber_', array($parcelNumberLabel, $parcelNumber));
        $field2[]          = $hctParcelNumber;
        
        // EmissionDate
        $emissionDateLabel = new MText('emissionDateLabel', _M('Emission date', $module).':');
        $emissionDateLabel->setWidth(FIELD_CONTAINER_SIZE);
        $emissionDate      = new MText('emissionDate_', $this->getFormValue('emissionDate', $data->emissionDate));
        $hctEmissionDate   = new MHContainer('hctEmissionDate', array($emissionDateLabel, $emissionDate));
        $field2[]          = $hctEmissionDate;

        // MaturityDate
        $maturityDateLabel = new MText('maturityDateLabel', _M('Maturity date', $module).':');
        $maturityDateLabel->setWidth(FIELD_CONTAINER_SIZE);
        $maturityDate      = new MText('maturityDate_', $this->getFormValue('maturityDate', $data->maturityDate));
        $hctMaturityDate   = new MHContainer('hctMaturityDate', array($maturityDateLabel, $maturityDate));
        $field2[]          = $hctMaturityDate;
        
        // Value
        $valueLabel = new MText('valueLabel', _M('Value', $module).':');
        $valueLabel->setWidth(FIELD_CONTAINER_SIZE);
        $value      = new MText('value_', SAGU::formatNumber($this->getFormValue('value', $data->value)));
        $hctValue   = new MHContainer('hctValue', array($valueLabel, $value));
        $field2[]   = $hctValue;

        
        
        // Automatic debit
        $automaticDebitLabel = new MText('automaticDebitLabel', _M('Automatic debit', $module).':');
        $automaticDebitLabel->setWidth(FIELD_CONTAINER_SIZE);
        $automaticDebit      = new MText('automaticDebit_', SAGU::getYesNo($this->getFormValue('automaticDebit', $data->automaticDebit)));
        $hctAutomaticDebit   = new MHContainer('hctAutomaticDebit', array($automaticDebitLabel, $automaticDebit));
        $field2[]            = $hctAutomaticDebit;
        
        // Comments
        $commentsLabel = new MText('commentsLabel', _M('Comments', $module).':');
        $commentsLabel->setWidth(FIELD_CONTAINER_SIZE);
        $comments      = new MText('comments_', $this->getFormValue('comments', strlen((string)$data->comments)>0 ? $data->comments : _M('This invoice do not have comments', $module)));
        $hctComments   = new MHContainer('hctComments', array($commentsLabel, $comments));
        $field2[]      = $hctComments;

        // Income source
        $businessIncomeSource = $MIOLO->getBusiness($module, 'BusIncomeSource');
        $incomeSourceData     = $businessIncomeSource->getIncomeSource($data->incomeSourceId);

        $incomeSourceLabel       = new MText('incomeSourceLabel', _M('Income source', $module).':');
        $incomeSourceLabel->setWidth(FIELD_CONTAINER_SIZE);

        $incomeSourceId          = new MText('incomeSourceId_', $incomeSourceData->incomeSourceId . ' - ' . $incomeSourceData->description);

        $hctIncomeSource         = new MHContainer('hctIncomeSource', array($incomeSourceLabel, $incomeSourceId));
        $hctIncomeSource->setShowLabel(true);
        $field2[]                = $hctIncomeSource;

        // Bank account
        $businessBankAccount    = $MIOLO->getBusiness($module, 'BusBankAccount');
        $bankAccountData        = $businessBankAccount->getBankAccount($data->bankAccountId);
        $bankAccountLabel       = new MText('bankAccountLabel', _M('Bank account', $module).':');
        $bankAccountLabel->setWidth(FIELD_CONTAINER_SIZE);
        $bankAccountId          = new MText('bankAccountId_', $this->getFormValue('bankAccountId', $data->bankAccountId.' - '.$bankAccountData->description));
        $hctBankAccount         = new MHContainer('hctBankAccount', array($bankAccountLabel, $bankAccountId));
        $hctBankAccount->setShowLabel(true);
        $field2[]               = $hctBankAccount;

        // Bank contract
        $businessBankAccountContract = $MIOLO->getBusiness($module, 'BusBankAccountContract');
        $bankContractData        = $businessBankAccountContract->getBankAccountContract($data->bankContractId, $data->bankAccountId);
        $bankContractLabel       = new MText('bankContractLabel', _M('Bank contract', $module).':');
        $bankContractLabel->setWidth(FIELD_CONTAINER_SIZE);
        $bankContractId          = new MText('bankContractId_', $this->getFormValue('bankContractId', $data->bankContractId.' - '.$bankContractData->description));
        $hctBankContract         = new MHContainer('hctBankContract', array($bankContractLabel, $bankContractId));
        $hctBankContract->setShowLabel(true);
        $field2[]               = $hctBankContract;
      
        // Policy
        $businessPolicy    = $MIOLO->getBusiness($module, 'BusPolicy');
        $policyData        = $businessPolicy->getPolicy($data->policyId);
        $policyLabel       = new MText('policyLabel', _M('Policy', $module).':');
        $policyLabel->setWidth(FIELD_CONTAINER_SIZE);
        $policyDescription = new MText('policyDescription_', $policyData->policyId.' - '.$policyData->description);
        $hctPolicy         = new MHContainer('hctPolicy', array($policyLabel, $policyDescription));
        $hctPolicy->setShowLabel(true);
        $field2[]          = $hctPolicy;
      
        // Collection type
        $businessCollectionType = $MIOLO->getBusiness($module, 'BusCollectionType');
        $collectionTypeData     = $businessCollectionType->getCollectionType($policyData->collectionTypeId);
        $collectionTypeLabel    = new MText('collectionTypeLabel', _M('Collection type', $module).':');
        $collectionTypeLabel->setWidth(FIELD_CONTAINER_SIZE);
        $collectionType         = new MText('collectionType_', $this->getFormValue('collectionType', $policyData->collectionTypeId.' - '.$collectionTypeData->description));
        $hctCollectionType      = new MHContainer('hctCollectionType', array($collectionTypeLabel, $collectionType));
        $field2[]               = $hctCollectionType;
      
        if (strlen((string)$data->sectorId)>0)
        {
            $businessSector = $MIOLO->getBusiness('basic', 'BusSector');
            $sectorData     = $businessSector->getSector($data->sectorId);
            $sectorLabel    = new MText('sectorLabel', _M('Sector', $module).':');
            $sectorLabel->setWidth(FIELD_CONTAINER_SIZE);
            $sector         = new MText('sectorId_', $this->getFormValue('sectorId', $sectorData->sectorId.' - '.$sectorData->description));
            $hctSector      = new MHContainer('hctSector', array($sectorLabel, $sector));
            $field2[]       = $hctSector;
        }

        // Message Invoice
        $messageInvoiceLabel    = new MText('messageInvoiceLabel', _M('Invoice message', $module).':');
        $messageInvoiceLabel->setWidth(FIELD_CONTAINER_SIZE);
        $messageInvoice         = new MText('messageInvoice', $this->getFormValue('messageInvoice', $data->messageInvoice));
        $hctMessageInvoice      = new MHContainer('hctMessageInvoice', array($messageInvoiceLabel, $messageInvoice));
        $field2[]               = $hctMessageInvoice;

        $bgInvoice = new MBaseGroup('bgInvoice', _M('Invoice information', $module), $field2);
        $bgInvoice->setDisposition('vertical');


        $fields[] = $bgInvoice;
        // END BASEGRID
        
        $this->setFields($fields);
        $this->setLabelWidth(FIELD_LABEL_SIZE);
    }

    /**
     * Update the nominal value
     */
    public function updateNominalValue_click($sender = null)
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $action = MIOLO::getCurrentAction();
        
        $invoiceId = MIOLO::_request('invoiceId') ? MIOLO::_request('invoiceId') : MIOLO::_request('invoiceId', 'GET');
        $businessReceivableInvoice = $MIOLO->getBusiness($module, 'BusReceivableInvoice');
        $businessReceivableInvoice->updateInvoiceBalance($invoiceId);
        $value = $businessReceivableInvoice->getNominalValue($invoiceId);
        $this->value_->value = $value;
    }
}
?>
