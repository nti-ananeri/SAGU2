<?php

/**
 * Research process handler.
 * Contains the menus to access process submenus
 *
 * @author Daniel Afonso Heisler [daniel@solis.coop.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Daniel Afonso Heisler [daniel@solis.coop.br]
 * Jamiel Spezia [jamiel@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 * Gustavo Scarantti Bremm [gsbremm@ftec.com.br]
 * Detley de Oliveira [ddocolombo@ftec.com.br]
 *
 * @since
 * Class created on 24/01/2006
 *
 * \b Organization: \n
 * SOLIS - Cooperativa de Solucoes Livres \n
 * The SAGU2 Development Team
 *
 * \b CopyLeft: \n
 * CopyLeft (L) 2005 SOLIS - Cooperativa de Solucoes Livres \n
 *
 * \b License: \n
 * Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html )
 *
 * \b History: \n
 * See history in CVS repository: http://sagu.solis.coop.br
 *
 **/

/**
 * Class to manipulate the basCountry table
 **/
class BusinessResearchBusFormSetting extends Business
{

    /**
     * Make a connection to the database
     * 
     * @param $module (string): The module whose database we should connect. If null, the actual module database is connected.
     *
     * @return (object): A MIOLO Database connection
     **/
    public function getDatabase($module = null)
    {
        $MIOLO = MIOLO::getInstance();
        $MIOLO->getClass('basic', 'sagu');
        $module = is_null($module) ? 'research' : $module;

        return $MIOLO->getDatabase($module);
    }
    
    /**
     * Return a specific record from the database
     *
     * @param $formId (integer): Primary key of the record to be retrieved
     *
     * @return (object): Return an object of the type handled by the class
     *
     **/
    public function getFormSetting($formSettingId)
    {
        $sql = 'SELECT A.formSettingId,
                       A.formId,
                       TO_CHAR(A.beginDate,\'' . MASK_DATE . '\'),
                       TO_CHAR(A.endDate,\'' . MASK_DATE . '\'),
                       TO_CHAR(A.beginHour,\'' . MASK_TIME . '\'),
                       TO_CHAR(A.endHour,\'' . MASK_TIME . '\'),
                       A.isProfessor,
                       A.isEmployee,
                       A.isStudent,
                       A.isInstitutionalEvaluation,
                       A.classId,
                       A.courseId,
                       A.courseVersion,
                       A.unitId,
                       A.turnId,
                       A.userName,
                       TO_CHAR(A.dateTime,\'' . MASK_TIMESTAMP . '\'),
                       A.ipAddress
                  FROM rshFormSetting A
                 WHERE A.formSettingId = ? ';

        $db     = $this->getDatabase();
        $result = $db->query(SAGU::prepare($sql, $formSettingId));
        //$db->close();

        $form = new rshFormSetting();
        list ( $form->formSettingId,
               $form->formId,
               $form->beginDate,
               $form->endDate,
               $form->beginHour,
               $form->endHour,
               $form->isProfessor,
               $form->isEmployee,
               $form->isStudent,
               $form->isInstitutionalEvaluation,
               $form->classId,
               $form->courseId,
               $form->courseVersion,
               $form->unitId,
               $form->turnId,
               $form->userName,
               $form->dateTime,
               $form->ipAdress ) = $result[0];

        return $form; 
    }
    
    public function getFormSettingByFormId($formId)
    {
        $sql = 'SELECT A.formSettingId,
                       A.formId,
                       TO_CHAR(A.beginDate,\'' . MASK_DATE . '\'),
                       TO_CHAR(A.endDate,\'' . MASK_DATE . '\'),
                       TO_CHAR(A.beginHour,\'' . MASK_TIME . '\'),
                       TO_CHAR(A.endHour,\'' . MASK_TIME . '\'),
                       A.isProfessor,
                       A.isEmployee,
                       A.isStudent,
                       A.isInstitutionalEvaluation,
                       A.classId,
                       A.courseId,
                       A.courseVersion,
                       A.unitId,
                       A.turnId,
                       A.userName,
                       TO_CHAR(A.dateTime,\'' . MASK_TIMESTAMP . '\'),
                       A.ipAddress
                  FROM rshFormSetting A
                 WHERE A.formId    = ? 
                   AND A.isStudent = true';

        $db     = $this->getDatabase();
        $result = $db->query(SAGU::prepare($sql, $formId));
        //$db->close();

        $form = new rshFormSetting();
        list ( $form->formSettingId,
               $form->formId,
               $form->beginDate,
               $form->endDate,
               $form->beginHour,
               $form->endHour,
               $form->isProfessor,
               $form->isEmployee,
               $form->isStudent,
               $form->isInstitutionalEvaluation,
               $form->classId,
               $form->courseId,
               $form->courseVersion,
               $form->unitId,
               $form->turnId,
               $form->userName,
               $form->dateTime,
               $form->ipAdress ) = $result[0];

        return $form; 
    }
    
    /**
     * Do a search on the database table handled by the class
     *
     * @param $filters (object): Search filters
     *
     * @return (array): An array containing the search results
     **/
    public function searchFormSetting($filters)
    {

        $sql= 'SELECT A.formSettingId,
                      A.formId,
                      B.description,
                      TO_CHAR(A.beginDate,\'' . MASK_DATE . '\'),
                      TO_CHAR(A.endDate,\'' . MASK_DATE . '\'),
                      TO_CHAR(A.beginHour,\'' . MASK_TIME . '\'),
                      TO_CHAR(A.endHour,\'' . MASK_TIME . '\'),
                      A.isProfessor,
                      A.isEmployee,
                      A.isStudent,
                      A.classId,
                      A.courseId,
                      A.courseVersion,
                      A.turnId,
                      C.description,
                      A.unitId,
                      D.description,
                      A.isInstitutionalEvaluation
                 FROM rshFormSetting A
           INNER JOIN rshForm B
                   ON ( A.formId = B.formId ) 
            LEFT JOIN basTurn C
                   ON ( A.turnId = C.turnId )
            LEFT JOIN basUnit D
                   ON ( A.unitId = D.unitId ) ';

        if ( strlen((string)$filters->formId) > 0 )
        {
            $where .= ' AND B.formId = ? ';
            $args[] = $filters->formId;
        }
        if ( strlen((string)$filters->formSettingId) > 0 )
        {
            $where .= ' AND A.formSettingId = ? ';
            $args[] = $filters->formSettingId;
        }
        if ( strlen((string)$filters->formDescription) > 0 )
        {
            $where .= ' AND B.description ILIKE ? ';
            $args[] = $filters->formDescription . '%';
        }
        if ( strlen((string)$filters->formShortDescription) > 0 )
        {
            $where .= ' AND B.shortDescription ILIKE ? ';
            $args[] = $filters->formShortDescription . '%';
        }
        if ( strlen((string)$filters->beginDate) > 0 )
        {
            $where .= ' AND A.beginDate >= TO_DATE(?,\'' . MASK_DATE . '\') ';
            $args[] = $filters->beginDate . '%';
        }
        if ( strlen((string)$filters->endDate) > 0 )
        {
            $where .= ' AND A.endDate <= TO_DATE(?,\'' . MASK_DATE . '\') ';
            $args[] = $filters->endDate . '%';
        }

        unset($result);
        if ( strlen((string)$where) > 0 )
        {
            $sql.= ' WHERE '.substr($where, 4).' ORDER BY B.description';
            $db = $this->getDatabase();
            $result = $db->query(SAGU::prepare($sql, $args));
            //$db->close();
        }

        return $result;
    }

    /**
     * Insert a new record
     *
     * @param $data (object): An object of the type handled by the class
     *
     * @return True if succed, otherwise False
     *
     **/
    public function insertFormSetting($data)
    {
       
        $sql = 'INSERT INTO rshFormSetting
                            (formId,
                             isProfessor,
                             isStudent,
                             isEmployee,
                             classId,
                             courseId,
                             courseVersion,
                             unitId,
                             turnId,
                             beginDate,
                             endDate,
                             beginHour,
                             endHour,
                             isInstitutionalEvaluation )
                     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?,
                             TO_DATE(?,\'' . MASK_DATE . '\'),
                             TO_DATE(?,\'' . MASK_DATE . '\'),
                             TO_TIMESTAMP(?,\'' . MASK_TIME . '\'),
                             TO_TIMESTAMP(?,\'' . MASK_TIME . '\'),
                             ? )';

        $args = array( $data->formId,
                       $data->isProfessor,
                       $data->isStudent,
                       $data->isEmployee,
                       $data->classId,
                       $data->courseId,
                       $data->courseVersion,
                       $data->unitId,
                       $data->turnId,
                       $data->beginDate,
                       $data->endDate,
                       $data->beginHour,
                       $data->endHour,
                       $data->isInstitutionalEvaluation);

        $db     = $this->getDatabase();
        $result = $db->execute(SAGU::prepare($sql, $args));
        //$db->close();
        return $result;
    }

    /**
     * Update data from a specific record
     *
     * @param $data (object): Data which will replace the old record data
     *
     * @return (boolean): True if succeed, otherwise False
     *
     **/
    public function updateFormSetting($data)
    {
        $sql = 'UPDATE rshFormSetting
                   SET formId        = ?,
                       beginDate     = TO_DATE(?,\'' . MASK_DATE . '\'),
                       endDate       = TO_DATE(?,\'' . MASK_DATE . '\'),
                       beginHour     = TO_TIMESTAMP(?,\'' . MASK_TIME . '\'),
                       endHour       = TO_TIMESTAMP(?,\'' . MASK_TIME . '\'),
                       isProfessor   = ?,
                       isStudent     = ?,
                       isEmployee    = ?,
                       classId       = ?,
                       courseId      = ?,
                       courseVersion = ?,
                       unitId        = ?,
                       turnId        = ?,
                       isInstitutionalEvaluation = ?
                 WHERE formSettingId = ?';

        $args = array( $data->formId,
                       $data->beginDate,
                       $data->endDate,
                       $data->beginHour,
                       $data->endHour,
                       $data->isProfessor,
                       $data->isStudent,
                       $data->isEmployee,
                       $data->classId,
                       $data->courseId,
                       $data->courseVersion,
                       $data->unitId,
                       $data->turnId,
                       $data->isInstitutionalEvaluation,
                       $data->formSettingId );

        $db   = $this->getDatabase();
        $sqls = SAGU::prepare($sql, $args);

        for ( $i=0; $i<count($sqls); $i++ )
        {
            $result = $db->execute($sqls[$i]);
        }

        //$db->close();

        return $result;
    }

    /**
     * Delete a record
     *
     * @param $formId (string): Primary key for deletion
     *
     * @return (boolean): True if succeed, otherwise False
     *
     **/
    public function deleteFormSetting($formSettingId)
    {
        $sql = 'DELETE FROM rshFormSetting
                      WHERE formSettingId = ? ';

        $db     = $this->getDatabase();
        $result = $db->execute(SAGU::prepare($sql, $formSettingId));
        //$db->close();
        return $result;
    }

    /**
     * Do a search on the database table handled by the class
     *
     * @param $personId (integer): Search for person codes
     * @param $personType (char): Search for person types.
     *                            P = Professor, E = Employee and S = student
     *
     * @return (array): An array containing the search results
     **/
    public function getPersonFormSetting($personId, $personType)
    {

        /* pega todos os questionários que exigem identificacao
           e que são do tipo pessoa = $personType */
        $sql= 'SELECT A.formId,
                      B.shortDescription,
                      A.classId,
                      A.courseId,
                      A.courseVersion,
                      A.unitId,
                      A.turnId,
                      A.isInstitutionalEvaluation
                 FROM rshFormSetting A
           INNER JOIN rshForm B
                   ON ( A.formId = B.formId )
                WHERE TO_TIMESTAMP(A.beginDate || \' \' || A.beginHour, \'yyyy-mm-dd hh24:mi:ss\') <= now()
                  AND TO_TIMESTAMP(A.endDate || \' \' || A.endHour, \'yyyy-mm-dd hh24:mi:ss\') >= now()
                  AND B.isIdentified = ? ';

        if ( $personType == 'P' )
        {
            $sql .= ' AND A.isProfessor = ?';
        }
        elseif ( $personType == 'S' )
        {
            $sql .= ' AND A.isStudent = ?';
        }
        elseif ( $personType == 'E' )
        {
            $sql .= ' AND A.isEmployee = ?';
        }

        $sql .= ' ORDER BY B.shortDescription';

        $db     = $this->getDatabase();

        $result = $db->query(SAGU::prepare($sql, array(DB_TRUE, DB_TRUE)));
        $res    = array();

        /* verifica quais desses questionários a pessoa não respondeu */
        if ( count($result)>0 )
        {
            $x = 0;
            foreach ( $result as $row )
            {
                list ( $formId,
                       $description,
                       $classId,
                       $courseId,
                       $courseVersion,
                       $unitId,
                       $turnId,
                       $isInstitutionalEvaluation ) = $row;

                //se for avaliação institucional
                if ( $isInstitutionalEvaluation == DB_TRUE )
                {
                    $sql= 'SELECT count(*)
                             FROM rshForm B
                       INNER JOIN rshQuestion C
                               ON ( B.formId = C.formId )
                       INNER JOIN rshOption D
                               ON ( C.questionId = D.questionId )
                       INNER JOIN rshAnswer_institutionalEvaluation E
                               ON ( E.questionId = C.questionId )
                            WHERE B.formId   = ?
                              AND E.personId = ?';

                    $db      = $this->getDatabase();
                    $result2 = $db->query(SAGU::prepare($sql, array($formId, $personId)));
                }
                else
                {
                    $sql= 'SELECT count(*)
                             FROM rshForm B
                       INNER JOIN rshQuestion C
                               ON ( B.formId = C.formId )
                       INNER JOIN rshOption D
                               ON ( C.questionId = D.questionId )
                       INNER JOIN rshAnswer E
                               ON ( D.optionId = E.optionId )
                            WHERE B.formId   = ?
                              AND E.personId = ?';

                    $db      = $this->getDatabase();
                    $result2 = $db->query(SAGU::prepare($sql, array($formId, $personId)));
                }

                //se o questionário ainda não foi respondido
                if ( !($result2[0][0] > 0) )
                {
                    //caso o questionário seja para uma turma específica
                    if ( strlen((string)$classId)>0 )
                    {
                        $sql = 'SELECT CASE WHEN count(*)>0 THEN true ELSE false END
                                  FROM acdClassPupil
                                 WHERE contractId IN ( SELECT contractId
                                                         FROM acdContract
                                                        WHERE personId = ?
                                                          AND isContractOut(contractId) = false )
                                   AND classId  = ?
                                   AND enddate IS NULL';
                        $args = array( $personId, $classId );
                        $res3 = $db->query(SAGU::prepare($sql, $args));
                        if ( $res3[0][0] == DB_TRUE )
                        {
                            $res[$x][0] = $formId;
                            $res[$x][1] = $description;
                            $x++;
                        }
                    }
                    //caso o questionário seja para um curso específico
                    elseif ( strlen((string)$courseId)>0 && strlen((string)$courseVersion)>0 &&
                             strlen((string)$unitId)>0 && strlen((string)$turnId)>0 )
                    {
                        $sql = 'SELECT CASE WHEN count(*)>0 THEN true ELSE false END
                                  FROM acdContract
                                 WHERE personId      = ?
                                   AND courseid      = ?
                                   AND courseVersion = ?
                                   AND turnId        = ?
                                   AND unitId        = ?
                                   AND isContractOut(contractId) = false';
                        $args = array( $personId, $courseId, $courseVersion, $turnId, $unitId );
                        $res3 = $db->query(SAGU::prepare($sql, $args));
                        if ( $res3[0][0] == DB_TRUE )
                        {
                            $res[$x][0] = $formId;
                            $res[$x][1] = $description;
                            $x++;
                        }
                    }
                    else
                    {
                        $res[$x][0] = $formId;
                        $res[$x][1] = $description;
                        $x++;
                    }
                }
            }
        }

        return $res;
    }

    /**
     * Verify if the person have rights to access someone form
     *
     * @param $personId (integer): Search for person codes
     * @param $fromId (integer): Form code
     * @param $$mioloUserName (varchar): Miolo user id
     *
     * @return (boolean): True if can, else false
     **/
    public function isFormAvaliable($formId, $personId=null)
    {

        $MIOLO = MIOLO::getInstance();
        $db    = $this->getDatabase();

        $busPerson = $MIOLO->getBusiness('basic', 'BusPerson');

        $setting   = $this->getFormSettingByFormId($formId);

        $sql= 'SELECT CASE WHEN count(*) >0 THEN true ELSE false END
                 FROM rshFormSetting A
           INNER JOIN rshForm B
                   ON ( A.formId = B.formId )
                WHERE TO_TIMESTAMP(A.beginDate || \' \' || A.beginHour, \'yyyy-mm-dd hh24:mi:ss\') <= now()
                  AND TO_TIMESTAMP(A.endDate || \' \' || A.endHour, \'yyyy-mm-dd hh24:mi:ss\') >= now()
                  AND A.formId       = ?
                  AND A.formId NOT IN ( SELECT C.formId 
                                          FROM rshQuestion C
                                    INNER JOIN rshForm RF using(formId)      
                                    INNER JOIN rshOption D
                                            ON ( C.questionId = D.questionId )';
        /* AVALIACAO INSTITUCIONAL */
        if ( $setting->isInstitutionalEvaluation == DB_TRUE )
        {
            $sql .= '               INNER JOIN rshAnswer_institutionalEvaluation E
                                            ON ( C.questionId = E.questionId )
                                         WHERE C.formId   = ?
                                           AND E.personId = ? AND ?)';
        }
        else
        {
            $sql .= '               INNER JOIN rshAnswer E
                                            ON ( D.optionId = E.optionId )
                                         WHERE C.formId   = ?
                                           AND E.personId = ?
                                           AND RF.isIdentified = ? )';
        }

        $args[] = $formId;
        $args[] = $formId;
        $args[] = $personId;
        $args[] = DB_TRUE;
        
        $result2 = $db->query(SAGU::prepare($sql, $args));
        
        
        if ( $result2[0][0] == DB_TRUE )
        {
            
        	$res[0][0] = DB_FALSE;
            
            if ( $busPerson->isPhysicalPersonProfessor($personId) == DB_TRUE )
            {
                $sql= 'SELECT CASE WHEN count(*) >0 THEN true ELSE false END
                         FROM rshFormSetting
                        WHERE formId      = ?
                          AND isProfessor = ?';
                unset($args);
                $args[] = $formId;
                $args[] = DB_TRUE;
                $res    = $db->query(SAGU::prepare($sql, $args));
                
            }
            if ( $busPerson->isPhysicalPersonStudent($personId) == DB_TRUE  && $res[0][0] == DB_FALSE )
            {
                $sql= 'SELECT classId,
                              courseId,
                              courseVersion,
                              unitId,
                              turnId                
                         FROM rshFormSetting
                        WHERE formId      = ?
                          AND isStudent   = ?';
                unset($args);
                $args[] = $formId;
                $args[] = DB_TRUE;
                $res    = $db->query(SAGU::prepare($sql, $args));
               

                if ( count($res)>0 )
                {

                    list ( $classId,
                           $courseId,
                           $courseVersion,
                           $unitId,
                           $turnId ) = $res[0];

                    //caso o questionário seja para uma turma específica
                    if ( strlen((string)$classId)>0 )
                    {
                        $sql = 'SELECT CASE WHEN count(*)>0 THEN true ELSE false END
                                  FROM acdClassPupil
                                 WHERE contractId IN ( SELECT contractId
                                                         FROM acdContract
                                                        WHERE personId = ?
                                                          AND isContractOut(contractId) = false )
                                   AND classId  = ?
                                   AND enddate IS NULL';
                        $args = array( $personId, $classId );
                        $res3 = $db->query(SAGU::prepare($sql, $args));
                        if ( $res3[0][0] == DB_TRUE )
                        {
                            $res[0][0] = DB_TRUE;
                        }
                    }
                    //caso o questionário sejA para um curso específico
                    elseif ( strlen((string)$courseId)>0 && strlen((string)$courseVersion)>0 &&
                             strlen((string)$unitId)>0 && strlen((string)$turnId)>0 )
                    {
                        $sql = 'SELECT CASE WHEN count(*)>0 THEN true ELSE false END
                                  FROM acdContract
                                 WHERE personId      = ?
                                   AND courseid      = ?
                                   AND courseVersion = ?
                                   AND turnId        = ?
                                   AND unitId        = ?
                                   AND isContractOut(contractId) = false';
                        $args = array( $personId, $courseId, $courseVersion, $turnId, $unitId );
                        $res3 = $db->query(SAGU::prepare($sql, $args));
                        if ( $res3[0][0] == DB_TRUE )
                        {
                            $res[0][0] = DB_TRUE;
                        }
                    }
                    else
                    {
                        $res[0][0] = DB_TRUE;
                    }
                }
                else
                {
                    $res[0][0] = DB_FALSE;
                }
            }
            if ( $busPerson->isPhysicalPersonEmployee($personId) == DB_TRUE  && $res[0][0] == DB_FALSE )
            {
                $sql= 'SELECT CASE WHEN count(*) >0 THEN true ELSE false END
                         FROM rshFormSetting
                        WHERE formId      = ?
                          AND isEmployee  = ?';
                unset($args);
                $args[] = $formId;
                $args[] = DB_TRUE;
                $res    = $db->query(SAGU::prepare($sql, $args));
                
            }
            
            if ( $res[0][0] == DB_TRUE )
            {
                $result[0][0] = DB_TRUE;
            }
            else
            {
                $result[0][0] = DB_FALSE;
            }
        }

        if ( $result[0][0] == DB_TRUE )
        {
            return true;
        }
        else
        {
            return false;
        }
    }
}
?>
