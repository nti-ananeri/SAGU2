<?php

$MIOLO  = MIOLO::getInstance();
$module = MIOLO::getCurrentModule();

class RptStatisticsByCurricularComponentCsv
{
    /**
     * Method to generate the report
     */
    public function RptStatisticsByCurricularComponentCsv($data = null)
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();

        //percorre os dados imprimindo eles no relatório
        if ( count($data) > 0 )
        {
            for ( $x=0; $x<count($data); $x++ )
            {

                if ( $x > 0 )
                {
                    list ( $oldCurricularComponentId,
                           $oldCurricularComponentVersion,
                           $oldCurricularComponentDescription,
                           $oldQuestionId,
                           $oldQuestionDescription,
                           $oldOptionId,
                           $oldOoptionDescription,
                           $oldTotal,
                           $oldTotalGeral,
                           $oldCourseId,
                           $oldCourseVersion,
                           $oldCourseName ) = $data[$x-1];
                }

                list ( $curricularComponentId,
                       $curricularComponentVersion,
                       $curricularComponentDescription,
                       $questionId,
                       $questionDescription,
                       $optionId,
                       $optionDescription,
                       $total,
                       $totalGeral,
                       $courseId,
                       $courseVersion,
                       $courseName ) = $data[$x];

                if ( $courseId != $oldCourseId || $courseVersion != $oldCourseVersion  )
                {
                    $str .= "\n" . $courseId . '/' . $courseVersion . ' - ' . $courseName . "\n\n";
                }

                if ( $curricularComponentId != $oldCurricularComponentId || $curricularComponentVersion != $oldCurricularComponentVersion  )
                {
                    $str .= $curricularComponentId . '/' .  $curricularComponentVersion . ' -  ' .  $curricularComponentDescription . "\n";
                }

                if ( $questionId != $oldQuestionId )
                {
                    $totalGeralUsado = $totalGeral;
                    $str .= $questionDescription . "\n";
                    $str .= 'Opção:;';
                    $str .= 'Total: ;';
                    $str .= 'Percentual:' . "\n";
                }

                $per = $total > 0 ? ($total * 100 / $totalGeralUsado) : 0;

                $str .= $optionDescription . ';';
                $str .= $total . ';';
                $str .= sprintf("%.2f", $per) . '%;' . "\n";

            }
        }
        $file = TEMP_DIR . '/' . 'StatisticsByCurricularComponent' . date('dmyhis') . '.csv';
        SAGU::returnAsFile($file, $str, 'application/csv', 'attachment');

    }

}

?>
