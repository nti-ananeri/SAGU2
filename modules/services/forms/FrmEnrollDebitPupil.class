<?php

class FrmEnrollDebitPupil extends MForm
{
    private $home;
    private $enrollData;

    /**
     * Class constructor
     **/
    function __construct($data)
    {
        $this->home = $data->home;

        parent::__construct('Pendências financeiras - Passo 2 de 5');
        $this->setHelp(get_class($this), MIOLO::getCurrentModule(), MIOLO::getCurrentAction());

        $this->eventHandler();
    }

    /**
     * Default method to define fields
     **/
    public function createFields()
    {
        $MIOLO    = MIOLO::getInstance();
        $module   = MIOLO::getCurrentModule();
        $action   = MIOLO::getCurrentAction();
        $function = MIOLO::_request('function');
        if(!$this->enrollData)
        {
            $this->enrollData = unserialize(urldecode(stripslashes($MIOLO->session->getValue('enrollData'))));
 
        }
        $session = $MIOLO->session;
        $personData->personId = $session->getValue('loginUid');
        $Error = false;
        $business = $MIOLO->getBusiness($module,'BusEnroll');

        //pega os dados da instituicao
        $businessCompany = $MIOLO->getBusiness('basic', 'BusCompany');
        $company         = $businessCompany->getCompany(DEFAULT_COMPANY_CONF);
        $businessLP = $MIOLO->getBusiness('basic', 'BusLegalPerson');
        $legalPerson        = $businessLP->getLegalPerson($company->personId);
		
		//Mensagens de ok
		$msg1  = 'Parabéns!  Nada consta de débitos ou pendências financeiras no nosso sistema.';
		$msg2  = 'Parabéns!  Nada consta de débitos ou pendências na Biblioteca.';

        //Checa pendÃªncia financeira local
        $debit = $business->getPersonBalance($personData->personId);
        //$debit = 0;
        if((float)$debit > 0 )
        {
            $this->addError('Há títulos vencendo hoje ainda não processados ou já vencidos. <br> Favor dirija-se à Central de Negociações. <br>Fone(s): '.$legalPerson->phone);
            $Error = true;
        }
		else
        {
            $msgTxt1     = new MText('msgTxt1', $msg1);
            $cntTxt1     = new MHContainer('cntTxt1', array($msgTxt1, $div1, $separator));
            $fields[] = $cntTxt1;
        }


        //Checa pendência financeira local
        $debit = $business->getPersonBalanceGnuteca($personData->personId);
        if((float)$debit > 0 )
        {
            $this->addError('Há débitos de biblioteca gerados para você, favor dirija-se à  Biblioteca.');
            $Error = true;
        }
		else
		{
	    $msgTxt2     = new MText('msgTxt2', $msg2);
        $cntTxt2     = new MHContainer('cntTxt2', array($msgTxt2, $div2, $separator));
	    $fields[] = $cntTxt2;
		}
	
        $flds[] = new MButton('tbBtnPrevious',_M('Previous','basic'),'');
        if (!$Error)
        {
            $flds[] = new MButton('tbBtnNext',_M('Next','basic'),'');
        }
        $divBtns       = new MDiv('divBtns', $flds, null, 'align="center"');

        $fields[] = $divBtns;
        $fields[] = new Separator('');
        $MIOLO->session->setValue('enrollData', urlencode(serialize($this->enrollData)));

        $this->setFields($fields);
        
        $this->setShowPostButton(false);
        $this->setClose($MIOLO->getActionURL($module,substr($action,0,strrpos($action,':'))));
    }

    public function tbBtnNext_click($sender = null)
    {
        $MIOLO    = MIOLO::getInstance();
        $module   = MIOLO::getCurrentModule();
        $action   = MIOLO::getCurrentAction();
        $MIOLO->session->setValue('enrollData', urlencode(serialize($this->enrollData)));

        $opts = array('page' => '3');  

        $this->page->mGoto($MIOLO->getActionURL($module, $action, null, $opts));
    }

    public function tbBtnPrevious_click($sender = null)
    {
        $MIOLO    = MIOLO::getInstance();
        $module   = MIOLO::getCurrentModule();
        $action   = MIOLO::getCurrentAction();
        $MIOLO->session->setValue('enrollData', urlencode(serialize($this->enrollData)));
        $opts = array('page' => '1');  
        $this->page->mGoto($MIOLO->getActionURL($module, $action, null, $opts));
    }
}

?>
