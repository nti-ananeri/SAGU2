<?php

/**
 *
 * This file is a report to pupils or employes from the respective financial situation
 *
 * @author Daniel Afonso Heisler [daniel@solis.coop.br]
 *
 * $version: $Id$
 *
 * \b Maintainers \n
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Daniel Afonso Heisler [daniel@solis.coop.br]
 * Jamiel Spezia [jamiel@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 * 
 * @since
 * Class created on 15/09/2006
 *
 * \b @organization \n
 * SOLIS - Cooperativa de Soluções Livres \n
 * The Sagu2 development team
 *
 * \b Copyleft \n
 * Copyleft (L) 2005 - SOLIS - Cooperativa de Soluções Livres \n
 *
 * \b License \n
 * Licensed under GPL (for further details read the COPYING file or http://www.gnu.org/copyleft/gpl.html )
 *
 * \b History \n
 * See history in CVS repository: http://sagu.solis.coop.br   
 *
 **/

/**
 * Grid used by form to display search results
 **/
class GrdFinancialConsultation extends MGrid
{
    /**
     * Class constructor
     **/
    function __construct($filters)
    {
        $MIOLO  = MIOLO::getInstance();
        $home   = $filters->home;
        $moduleLocale = 'finance';

        $columns = array( new MGridColumn( _M('Period',        $moduleLocale), 'center', true, null, true, null, false ),
                          new MGridColumn( _M('Invoice id',    $moduleLocale), 'center', true, null, true, null, false ),
                          new MGridColumn( _M('Emission date', $moduleLocale), 'center', true, null, true, null, false ),
                          new MGridColumn( _M('Maturity date', $moduleLocale), 'center', true, null, true, null, false ),
                          new MGridColumn( _M('Value',         $moduleLocale), 'right',  true, null, true, null, false ),
                          new MGridColumn( _M('Days',          $moduleLocale), 'center', true, null, true, null, false ),
                          new MGridColumn( _M('Balance',       $moduleLocale), 'right',  true, null, true, null, false )
                        );

        $url = $MIOLO->getActionURL( 'services', $filters->home );
        parent::__construct( null, $columns, $url, 0, 0, 'gridFinancialConsultation' );
        $this->setRowMethod('GrdFinancialConsultation', 'myRowMethod');

        $opts      = array('invoiceId' => '%1%');
        $href_view = $MIOLO->getActionURL( 'services', "main:pupil:receivableInvoiceView", null, $opts );
        $this->addActionIcon(_M('More informations', 'services'), 'view.png', $href_view);
        
        // Print the invoice
        $_opts     = array('event'=>'btnSearch_click', 'personId'=>$filters->personId);
        $opts      = array('event'=>'submit_button_click', '_invoiceId'=>'%1%');
        $hrefPrint = $MIOLO->getActionURL('finance', "main:process:printInvoice", null, $opts);
        $this->addActionIcon(_M('Print invoice', 'services'), array('print2.png', 'print2_disable.png'), $hrefPrint);

        $this->eventHandler();
    }
    
    /*
     * Event to execute for each row of grid
     */
    public function myRowMethod($i, $row, $actions, $columns )
    {
        $MIOLO = MIOLO::getInstance();
        $businessInvoice = $MIOLO->getBusiness('finance', 'BusInvoice');

        for ( $x = 1; $x<count($columns); $x++ )
        {
            if ( $x == 5 )
            {
                if ( $row[5] == '(x)' )
                {
                   $color = 'blue';
                }
                elseif ( $row[5] >= 0 )
                {
                    $color = 'red';
                }
                elseif ( $row[5] < 0 )
                {
                   $color = 'green';
                }
                $columns[$x]->control[$i]->_addStyle( 'color', $color );
            }
        }

        if ( $row[6] < SAGU::formatNumber(MINIMAL_VALUE_TO_PRINT_INVOICE))
        {
            $actions[1]->enabled = false;
        }
        else
        {
            $actions[1]->enabled = true;
        }

        $actions[1]->value = 'icon_' . $row[7] . '.png';
        $actions[1]->valueoff = 'icon_' . $row[7] . '_disable.png';
    }
}
?>
